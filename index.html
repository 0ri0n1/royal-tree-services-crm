<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClientTrack Pro</title>
    <style>
        :root {
            /* Colors */
            --primary-color: #2e7d32;
            --primary-color-light: #4caf50;
            --primary-color-dark: #1b5e20;
            --secondary-color: #f57c00;
            --success-color: #43a047;
            --warning-color: #ff9800;
            --danger-color: #e53935;
            --info-color: #1976d2;
            
            /* RGB versions of colors for rgba() usage */
            --primary-color-rgb: 46, 125, 50;
            --primary-color-light-rgb: 76, 175, 80;
            --primary-color-dark-rgb: 27, 94, 32;
            --secondary-color-rgb: 245, 124, 0;
            --success-color-rgb: 67, 160, 71;
            --warning-color-rgb: 255, 152, 0;
            --danger-color-rgb: 229, 57, 53;
            --info-color-rgb: 25, 118, 210;
            
            /* Text colors */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-light: #ffffff;
            
            /* Background colors */
            --bg-light: #ffffff;
            --bg-card: #f9f9f9;
            --bg-dark: #212121;
            
            /* Border colors */
            --border-color: #e0e0e0;
            --border-color-rgb: 224, 224, 224;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            
            /* Border radius */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            
            /* Font sizes */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.25rem;
            --font-size-xl: 1.5rem;
            --font-size-xxl: 2rem;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Transitions */
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            color: var(--text-primary);
            background-color: var(--bg-light);
            line-height: 1.6;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: var(--text-light);
            padding: var(--spacing-sm) var(--spacing-md);
            z-index: 100;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: var(--spacing-md) 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo svg {
            margin-right: var(--spacing-sm);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-left: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-speed);
        }

        nav a:hover, nav a:focus {
            background-color: var(--primary-dark);
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .stat-card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Client Table */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-xs) var(--spacing-sm);
            box-shadow: var(--shadow-sm);
            width: 100%;
            max-width: 400px;
        }

        .search-bar input {
            border: none;
            background: transparent;
            padding: var(--spacing-xs) var(--spacing-sm);
            width: 100%;
            font-size: var(--font-size-md);
        }

        .search-bar input:focus {
            outline: none;
        }

        button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: var(--font-size-md);
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button svg {
            margin-right: var(--spacing-xs);
        }

        button:hover, button:focus {
            background-color: var(--primary-color-dark);
            outline: none;
        }

        button.secondary {
            background-color: var(--secondary-color);
        }

        button.secondary:hover, button.secondary:focus {
            background-color: #e65100;
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover, button.danger:focus {
            background-color: #d32f2f;
        }

        button.sm {
            font-size: var(--font-size-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        .table-container {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--bg-light);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        th::after {
            content: "";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        th.asc::after {
            content: "▲";
        }

        th.desc::after {
            content: "▼";
        }

        tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Status badge styling */
        .status-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-new {
            background-color: var(--info-color);
            color: var(--text-light);
        }
        
        .status-quote {
            background-color: var(--warning-color);
            color: var(--text-dark);
        }
        
        .status-active {
            background-color: var(--success-color);
            color: var(--text-light);
        }
        
        .status-completed {
            background-color: var(--secondary-color);
            color: var(--text-light);
        }
        
        .status-inactive {
            background-color: var(--text-secondary);
            color: var(--text-light);
        }

        .priority-low {
            border-left: none;
        }

        .priority-medium {
            border-left: none;
        }

        .priority-high {
            border-left: none;
        }

        .priority-urgent {
            border-left: none;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-xs);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: var(--spacing-md);
            gap: var(--spacing-xs);
        }

        .pagination button {
            min-width: 35px;
            height: 35px;
            padding: 0;
        }

        .pagination button.active {
            background-color: var(--primary-dark);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }

        .modal {
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: var(--spacing-md);
        }

        .modal-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Forms */
        form {
            display: grid;
            gap: var(--spacing-md);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-secondary);
        }

        input, textarea, select {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-family: var(--font-family);
            font-size: var(--font-size-md);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 122, 42, 0.2);
        }

        .form-error {
            color: var(--danger-color);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .toast {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background-color: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            animation: toastFadeIn 0.3s ease-out;
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast-info {
            border-left: 4px solid var(--info-color);
        }

        .toast-icon {
            margin-right: var(--spacing-sm);
            flex-shrink: 0;
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        /* App background */
        body {
            background-color: #f8f9fa;
            background-image: linear-gradient(315deg, #fcfcfc 0%, #eff5ef 74%);
            min-height: 100vh;
        }

        /* Theme styles */
        body.dark {
            --primary-color: #1b5e1a;
            --primary-dark: #0d4a0c;
            --primary-light: #2c7a2a;
            --secondary-color: #6d5424;
            --accent-color: #b39242;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-light: #ffffff;
            --bg-light: #222222;
            --bg-dark: #111111;
            --bg-card: #333333;
            --border-color: #444444;
            
            background-color: #222222;
            background-image: linear-gradient(315deg, #1a1a1a 0%, #2a2a2a 74%);
            color: var(--text-primary);
        }

        body.forest {
            --primary-color: #2e8b57;
            --primary-dark: #1e6e3c;
            --primary-light: #3ea76c;
            --secondary-color: #8b4513;
            --accent-color: #deb887;
            --text-primary: #333333;
            --text-secondary: #555555;
            --text-light: #ffffff;
            --bg-light: #f0f7f0;
            --bg-dark: #2c3e2c;
            --bg-card: #ffffff;
            --border-color: #c8d6c8;
            
            background-color: #f0f7f0;
            background-image: linear-gradient(315deg, #e8f3e8 0%, #f0f7f0 74%);
        }

        /* Checkbox styles */
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            width: 18px;
            height: 18px;
        }

        /* Reports styles */
        .reports-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .report-results {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }

        .report-results h3 {
            margin-bottom: var(--spacing-md);
            color: var(--primary);
        }

        .report-summary {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: var(--border-radius-sm);
        }

        .report-table {
            width: 100%;
            margin-bottom: var(--spacing-md);
        }

        .report-table th {
            background-color: var(--primary-light);
            color: var(--text-light);
            text-align: left;
            padding: var(--spacing-sm);
        }

        .report-table td {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .report-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: var(--spacing-md);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-md);
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-bar {
                max-width: 100%;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .modal {
                max-width: 95%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Animation for elements */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* For screen readers only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus visible utility */
        .focus-visible:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .modal {
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        /* Clients Modal Styles */
        .clients-modal-content {
            padding: 1rem;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }
        
        /* Filter controls styling */
        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: var(--bg-light);
            padding: 1rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .view-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        
        .view-filters button {
            padding: 0.5rem 1rem;
            font-size: var(--font-size-sm);
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-filters button:hover {
            background-color: var(--bg-hover);
        }
        
        .view-filters button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }
        
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-toggle button {
            padding: 0.5rem;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button:hover {
            background-color: var(--bg-hover);
        }
        
        .view-toggle button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }
        
        .client-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .client-card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .client-card-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-light);
        }
        
        .client-card-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }
        
        .client-card-body {
            padding: 1rem;
            color: var(--text-primary);
        }
        
        .client-card-body p {
            margin: 0.5rem 0;
        }
        
        .client-dates {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
        }
        
        .client-card-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }
        
        /* Priority indicators */
        .priority-indicator {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            margin-left: 0.25rem;
        }
        
        .priority-high {
            color: var(--danger-color);
        }
        
        .priority-medium {
            color: var(--warning-color);
        }
        
        .priority-low {
            color: var(--success-color);
        }
        
        .priority-urgent {
            color: #f44336;
        }
        
        /* Remove priority border colors for client cards */
        .client-card.priority-high,
        .client-card.priority-medium,
        .client-card.priority-low,
        .client-card.priority-urgent {
            border-left: none;
        }
        
        /* No results styling */
        .no-results {
            padding: 2rem;
            text-align: center;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            color: var(--text-secondary);
            font-style: italic;
            width: 100%;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .view-filters {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            
            .client-cards {
                grid-template-columns: 1fr;
            }
        }
        
        /* Client list table styles */
        .client-list {
            overflow-x: auto;
            margin-top: 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            background-color: var(--bg-card);
        }
        
        .client-list th {
            background-color: var(--bg-light);
            color: var(--text-primary);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .client-list td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-primary);
        }
        
        .client-list tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        /* Priority row styling - use text color instead of border */
        .client-list tr.priority-high,
        .client-list tr.priority-medium,
        .client-list tr.priority-low,
        .client-list tr.priority-urgent {
            border-left: none;
        }
        
        /* Search box styles */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
            margin-right: 1rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.6rem 2.5rem 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-md);
            transition: all 0.2s;
            background-color: var(--bg-card);
        }
        
        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
            outline: none;
        }
        
        .clear-search {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            border-radius: 50%;
        }
        
        .clear-search:hover {
            color: var(--danger-color);
            background-color: rgba(var(--danger-rgb), 0.1);
        }
        
        /* Results counter */
        .results-counter {
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-md);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            display: inline-block;
        }
        
        .results-counter span {
            font-style: italic;
        }
        
        /* Responsive table */
        @media (max-width: 992px) {
            .client-list table {
                min-width: 800px;
            }
        }
        
        @media (max-width: 768px) {
            .search-box {
                max-width: 100%;
                margin-right: 0;
                margin-bottom: 1rem;
            }
        }

        /* Ensure client names and phone numbers are black */
        .table-container td,
        .client-list td {
            color: var(--text-primary) !important;
        }

        /* Reset any color inheritance from priority classes */
        tr.priority-high td,
        tr.priority-medium td,
        tr.priority-low td,
        tr.priority-urgent td {
            color: var(--text-primary) !important;
        }

        /* Priority Matrix Component */
        .priority-matrix-container {
            margin-top: 2rem;
            padding: 1rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }

        .matrix-header {
            margin-bottom: 1rem;
            text-align: center;
        }

        .matrix-grid {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .matrix-axis-labels {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .y-axis-label, .x-axis-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .matrix-quadrants {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .matrix-row {
            display: flex;
            gap: 1rem;
        }

        .matrix-quadrant {
            flex: 1;
            padding: 1rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }

        .quadrant-header {
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .quadrant-clients {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .matrix-client-card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
            cursor: pointer;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .matrix-client-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .matrix-client-name {
            font-weight: bold;
        }

        .matrix-client-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .matrix-client-quote {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Priority Matrix Component - Enhanced Styling */
        .matrix-quadrant.q1 {
            background-color: rgba(244, 67, 54, 0.1); /* Urgent/Important - Light red */
            border-top: 3px solid var(--danger-color);
            border-right: 3px solid var(--danger-color);
        }
        
        .matrix-quadrant.q2 {
            background-color: rgba(33, 150, 243, 0.1); /* Important, Not Urgent - Light blue */
            border-top: 3px solid var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }
        
        .matrix-quadrant.q3 {
            background-color: rgba(255, 193, 7, 0.1); /* Urgent, Not Important - Light yellow */
            border-bottom: 3px solid var(--warning-color);
            border-right: 3px solid var(--warning-color);
        }
        
        .matrix-quadrant.q4 {
            background-color: rgba(139, 195, 74, 0.1); /* Not Urgent, Not Important - Light green */
            border-bottom: 3px solid var(--success-color);
            border-left: 3px solid var(--success-color);
        }
        
        .matrix-client-scores {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Priority Dashboard Styles */
        .priority-dashboard {
            margin: var(--spacing-lg) 0;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }
        
        .priority-dashboard h2 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }
        
        .priority-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }
        
        .priority-column {
            background-color: var(--bg-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm);
            min-height: 200px;
        }
        
        .priority-urgent-column {
            border-top: 3px solid var(--danger-color);
        }
        
        .priority-high-column {
            border-top: 3px solid var(--warning-color);
        }
        
        .priority-medium-column {
            border-top: 3px solid var(--primary-color);
        }
        
        .priority-low-column {
            border-top: 3px solid var(--success-color);
        }
        
        .priority-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--border-color);
        }
        
        .priority-column-header h3 {
            margin: 0;
            font-size: var(--font-size-md);
        }
        
        .client-count {
            background-color: var(--bg-card);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
        }
        
        .priority-client-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .priority-client-card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .priority-client-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .priority-client-name {
            font-weight: bold;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }
        
        .priority-client-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        
        .client-value-badge {
            font-size: var(--font-size-xs);
            background-color: var(--bg-light);
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
        }
        
        .priority-client-date {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }
        
        .empty-priority-message {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: var(--spacing-md);
        }

        /* Financial Forecaster Styles */
        .financial-forecaster {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }

        .forecaster-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .financial-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            flex: 1;
            min-width: 200px;
            padding: 1.25rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .summary-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: var(--font-size-md);
            color: var(--text-secondary);
        }

        .summary-value {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--primary-color);
        }

        .chart-section {
            padding: 1.5rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .chart-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }

        .earnings-chart {
            position: relative;
            margin-top: 1.5rem;
            padding-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-left: 50px;
            margin-bottom: 30px;
        }

        .y-axis {
            position: absolute;
            top: 0;
            left: -50px;
            width: 50px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-right: 10px;
            border-right: 1px solid var(--border-color);
        }

        .y-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            text-align: right;
            white-space: nowrap;
            transform: translateY(-50%);
        }

        .chart-content {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .chart-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .grid-line {
            width: 100%;
            height: 1px;
            background-color: rgba(var(--border-color-rgb), 0.2);
        }

        .chart-bars {
            position: relative;
            display: flex;
            justify-content: space-between;
            height: 100%;
            z-index: 2;
        }

        .chart-column {
            flex: 1;
            position: relative;
            margin: 0 5px;
        }

        .bar-container {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .confirmed-bar {
            background-color: var(--success-color);
            z-index: 3;
        }

        .potential-bar {
            background-color: var(--warning-color);
            opacity: 0.8;
            z-index: 2;
        }

        .x-axis {
            display: flex;
            justify-content: space-between;
            margin-left: 50px;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid var(--border-color);
        }

        .x-label {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            text-align: center;
            margin: 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .confirmed-color {
            background-color: var(--success-color);
        }

        .potential-color {
            background-color: var(--warning-color);
            opacity: 0.8;
        }

        .legend-item div {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .forecast-insights {
            padding: 1.5rem;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
        }

        .forecast-insights h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }

        .forecast-insights ul {
            list-style: none;
            padding-left: 0;
        }

        .forecast-insights li {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .forecast-insights li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .range-value {
            display: inline-block;
            margin-left: 0.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Calendar Styles */
        .calendar-container {
            margin: var(--spacing-lg) 0;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-container h2 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .calendar-navigation {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .calendar-date-display {
            font-size: var(--font-size-lg);
            font-weight: bold;
        }
        
        .calendar-view-options {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .calendar-view-options button {
            padding: var(--spacing-xs) var(--spacing-sm);
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary-color-light);
            color: var(--text-light);
            font-weight: bold;
            border-top-left-radius: var(--border-radius-sm);
            border-top-right-radius: var(--border-radius-sm);
        }
        
        .calendar-weekday {
            padding: var(--spacing-sm);
            text-align: center;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(100px, auto);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: var(--border-radius-sm);
            border-bottom-right-radius: var(--border-radius-sm);
        }
        
        .calendar-day {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-xs);
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        
        .calendar-day:nth-last-child(-n+7) {
            border-bottom: none;
        }
        
        .calendar-day-header {
            font-weight: bold;
            margin-bottom: var(--spacing-xs);
            text-align: right;
        }
        
        .calendar-day.today {
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }
        
        .calendar-day.today .calendar-day-header {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .calendar-day.different-month {
            background-color: rgba(0, 0, 0, 0.02);
            color: var(--text-secondary);
        }
        
        .calendar-day-events {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            font-size: var(--font-size-sm);
        }
        
        .calendar-event {
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            background-color: var(--bg-light);
            border-left: 3px solid;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s;
        }
        
        .calendar-event:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1);
        }
        
        .calendar-event.priority-urgent {
            border-left-color: var(--danger-color);
        }
        
        .calendar-event.priority-high {
            border-left-color: var(--warning-color);
        }
        
        .calendar-event.priority-medium {
            border-left-color: var(--primary-color);
        }
        
        .calendar-event.priority-low {
            border-left-color: var(--success-color);
        }
        
        .calendar-event.status-active {
            background-color: rgba(var(--success-color-rgb), 0.1);
        }
        
        .calendar-event.status-quote {
            background-color: rgba(var(--warning-color-rgb), 0.1);
        }
        
        .calendar-event.status-new {
            background-color: rgba(var(--info-color-rgb), 0.1);
        }
        
        .calendar-event.status-completed {
            background-color: rgba(var(--secondary-color-rgb), 0.1);
            text-decoration: line-through;
        }
        
        .calendar-week-view {
            display: flex;
            flex-direction: column;
        }
        
        .calendar-week-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 400px;
            border: 1px solid var(--border-color);
        }
        
        .calendar-week-column {
            padding: var(--spacing-xs);
            border-right: 1px solid var(--border-color);
        }
        
        .calendar-week-column:last-child {
            border-right: none;
        }
        
        .calendar-day-view {
            min-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
        }
        
        .calendar-day-body {
            padding: var(--spacing-md);
        }
        
        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .calendar-days {
                grid-auto-rows: minmax(80px, auto);
            }
            
            .calendar-event {
                font-size: var(--font-size-xs);
                padding: 2px 4px;
            }
        }

        /* Client Map Styles */
        .client-map-container {
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(var(--primary-color-dark-rgb), 0.1);
            background-color: var(--bg-card);
            padding: 20px;
        }

        .client-map-container h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-map {
            height: 500px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid rgba(var(--primary-color-rgb), 0.2);
        }

        .map-controls {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .map-legend {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .map-legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .loading-map {
            height: 500px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f5f5f5;
            color: var(--text-secondary);
            font-style: italic;
        }

        .marker-urgent {
            background-color: var(--danger-color);
        }

        .marker-high {
            background-color: var(--warning-color);
        }

        .marker-medium {
            background-color: var(--primary-color);
        }

        .marker-low {
            background-color: var(--info-color);
        }

        .marker-completed {
            background-color: var(--success-color);
        }

        .map-error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 1rem;
        }

        .marker-low {
            background-color: var(--info-color);
        }

        .marker-completed {
            background-color: var(--success-color);
        }
        
        .map-error-message {
            color: var(--danger-color);
            text-align: center;
            margin: 1rem auto;
            padding: 1rem;
            background-color: rgba(var(--danger-color-rgb), 0.1);
            border-radius: var(--border-radius-md);
            font-weight: 500;
            max-width: 80%;
        }
        
        .info-window h3 {
            color: var(--primary-color-dark);
            margin-top: 0;
            margin-bottom: 8px;
        }
        
        .info-window button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .info-window button:hover {
            background-color: var(--primary-color-dark);
        }
        
        .map-helper-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .map-helper-buttons button {
            flex: 1;
            margin: 0;
        }
        
        .input-with-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        button.sm {
            font-size: var(--font-size-sm);
            padding: 0.25rem 0.5rem;
        }
        
        /* Coordinate section enhancements */
        .form-coordinate-note {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 3px solid #6c757d;
            border-radius: 4px;
        }
        
        /* Optional label styling */
        .optional-label {
            font-size: 0.85em;
            font-weight: normal;
            color: #6c757d;
            font-style: italic;
        }
        
        .form-coordinate-note ul {
            margin-top: 5px;
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .form-coordinate-note li {
            margin-bottom: 3px;
        }
        
        .info-icon {
            margin-right: 5px;
            font-style: normal;
        }
        
        .input-with-button {
            display: flex;
            align-items: center;
        }
        
        .input-with-button input {
            flex: 1;
        }
        
        .map-helper-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .map-helper-buttons button {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .map-helper-buttons button:first-child {
            background-color: #28a745;
            color: white;
            border: 1px solid #28a745;
        }
        
        .map-helper-buttons button:first-child:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        .map-helper-buttons button:last-child {
            background-color: #6c757d;
            color: white;
            border: 1px solid #6c757d;
        }
        
        .map-helper-buttons button:last-child:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        /* Map helper buttons styling */
        .map-helper-buttons button:last-child:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        /* Google Calendar Integration Styles */
        .google-calendar-integration {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .calendar-auth-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .calendar-auth-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #343a40;
        }
        
        .calendar-button {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .calendar-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .calendar-status.connected {
            color: #28a745;
        }
        
        .status-icon {
            font-size: 1.2rem;
        }
        
        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .calendar-events-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .calendar-events-list h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .event-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #4285F4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .event-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .event-time {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .event-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }
        
        .refresh-button {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .calendar-events-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .calendar-integration-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .calendar-integration-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        
        .event-description {
            white-space: pre-line;
            margin-top: 5px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        /* Calendar event styling for Google events */
        .calendar-event[class*="type-google"] {
            background-color: #4285F4;
            color: white;
            border-left: 3px solid #0F9D58;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script>
        // Global function for Google Maps initialization
        function initMap() {
            try {
                console.log("Google Maps API loaded");
                // Dispatch custom event to notify our components that Google Maps is ready
                if (window) {
                    window.dispatchEvent(new Event('google-maps-loaded'));
                    console.log("google-maps-loaded event dispatched");
                }
            } catch (error) {
                console.error("Error dispatching Google Maps loaded event:", error);
            }
        }
    </script>
    
    <!-- Google Maps API with Places library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnRL1By1nSeEmOJmGKM6O62NLHjA0WSZM&libraries=places,drawing&callback=initMap" defer></script>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        // Google Calendar API configuration
        const CALENDAR_API_KEY = 'AIzaSyBW7J_M4whLtYNGE6sVHXBmeTVkZaGYw48'; // Use the same key as Maps or create a new one
        const CALENDAR_CLIENT_ID = '795789422278-rphc8sou0n24qbpbpuc7g3lvl9vjcj30.apps.googleusercontent.com'; // Replace with your actual client ID
        const CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        // Initialize the Google API Client Library
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CALENDAR_API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            });
            gapiInited = true;
            maybeEnableCalendarButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CALENDAR_CLIENT_ID,
                scope: CALENDAR_SCOPES,
                callback: '', // Will be set later
            });
            gisInited = true;
            maybeEnableCalendarButtons();
        }
        
        function maybeEnableCalendarButtons() {
            if (gapiInited && gisInited) {
                // Enable calendar buttons when APIs are loaded
                document.querySelectorAll('.calendar-button').forEach(button => {
                    button.disabled = false;
                });
            }
        }
        
        // Handle authentication for calendar access
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                await listUpcomingEvents();
                updateCalendarStatus(true);
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        // Revoke the access token
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateCalendarStatus(false);
            }
        }
        
        // Update UI elements based on sign-in status
        function updateCalendarStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('calendar-authorize').style.display = 'none';
                document.getElementById('calendar-signout').style.display = 'block';
                document.querySelectorAll('.calendar-feature').forEach(el => {
                    el.style.display = 'block';
                });
            } else {
                document.getElementById('calendar-authorize').style.display = 'block';
                document.getElementById('calendar-signout').style.display = 'none';
                document.querySelectorAll('.calendar-feature').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }
        
        // List upcoming events
        async function listUpcomingEvents() {
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime'
                });
                
                const events = response.result.items;
                const calendarEventsList = document.getElementById('calendar-events');
                
                if (!events || events.length === 0) {
                    calendarEventsList.innerHTML = '<p>No upcoming events found.</p>';
                    return;
                }
                
                // Display events
                let eventsHtml = '<ul class="event-list">';
                events.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const formattedDate = new Date(start).toLocaleString();
                    eventsHtml += `<li>
                        <div class="event-item">
                            <div class="event-title">${event.summary}</div>
                            <div class="event-time">${formattedDate}</div>
                            <div class="event-actions">
                                <button onclick="viewEventDetails('${event.id}')" class="btn-sm">View</button>
                            </div>
                        </div>
                    </li>`;
                });
                eventsHtml += '</ul>';
                calendarEventsList.innerHTML = eventsHtml;
            } catch (err) {
                console.error('Error fetching calendar events:', err);
                document.getElementById('calendar-events').innerHTML = 
                    '<p class="error-message">Error loading events. Please try again later.</p>';
            }
        }
        
        // Create a calendar event for a client
        async function createClientEvent(clientData, appointmentDetails) {
            if (!gapi.client.getToken()) {
                alert('Please authorize access to Google Calendar first.');
                return;
            }
            
            try {
                // Format address for location field
                const location = clientData.address || '';
                
                // Create event object
                const event = {
                    'summary': `Appointment with ${clientData.name}`,
                    'location': location,
                    'description': `
                        Service: ${appointmentDetails.service || ''}
                        Notes: ${appointmentDetails.notes || ''}
                        Client Phone: ${clientData.phone || ''}
                        Client Email: ${clientData.email || ''}
                    `,
                    'start': {
                        'dateTime': appointmentDetails.startTime,
                        'timeZone': 'America/Edmonton' // Canadian time zone, adjust if needed
                    },
                    'end': {
                        'dateTime': appointmentDetails.endTime,
                        'timeZone': 'America/Edmonton'
                    },
                    'reminders': {
                        'useDefault': false,
                        'overrides': [
                            {'method': 'email', 'minutes': 24 * 60}, // 1 day email reminder
                            {'method': 'popup', 'minutes': 60} // 1 hour popup reminder
                        ]
                    }
                };
                
                // Add event to calendar
                const request = gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                
                const response = await request;
                console.log('Event created: %s', response.result.htmlLink);
                
                // Update client record with appointment info
                updateClientWithAppointment(clientData.id, {
                    eventId: response.result.id,
                    eventLink: response.result.htmlLink,
                    scheduledDate: appointmentDetails.startTime
                });
                
                return response.result;
            } catch (error) {
                console.error('Error creating calendar event:', error);
                alert('Failed to create calendar event. Please try again.');
                return null;
            }
        }
        
        // Update client record with appointment information
        function updateClientWithAppointment(clientId, appointmentInfo) {
            // Get existing clients
            const clients = JSON.parse(localStorage.getItem('clients')) || [];
            
            // Find and update the specific client
            const updatedClients = clients.map(client => {
                if (client.id === clientId) {
                    return {
                        ...client,
                        scheduledDate: appointmentInfo.scheduledDate,
                        status: client.status === 'New' ? 'Active' : client.status,
                        calendarEventId: appointmentInfo.eventId,
                        calendarEventLink: appointmentInfo.eventLink
                    };
                }
                return client;
            });
            
            // Save updated clients back to storage
            localStorage.setItem('clients', JSON.stringify(updatedClients));
            
            // Refresh the client list display
            refreshClientList();
        }
        
        // View event details
        async function viewEventDetails(eventId) {
            try {
                const response = await gapi.client.calendar.events.get({
                    'calendarId': 'primary',
                    'eventId': eventId
                });
                
                const event = response.result;
                
                // Create modal with event details
                const modalHtml = `
                    <div class="modal-header">
                        <h2>${event.summary}</h2>
                        <span class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p><strong>When:</strong> ${new Date(event.start.dateTime || event.start.date).toLocaleString()} - 
                            ${new Date(event.end.dateTime || event.end.date).toLocaleTimeString()}</p>
                        <p><strong>Where:</strong> ${event.location || 'Not specified'}</p>
                        <div class="event-description">
                            <strong>Description:</strong>
                            <pre>${event.description || 'No description provided.'}</pre>
                        </div>
                        <div class="event-actions">
                            <a href="${event.htmlLink}" target="_blank" class="btn">Open in Google Calendar</a>
                        </div>
                    </div>
                `;
                
                showModal(modalHtml);
            } catch (error) {
                console.error('Error fetching event details:', error);
                alert('Failed to load event details. Please try again.');
            }
        }
    </script>
    
    <!-- Include the Google API loading callbacks -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <!-- Application code -->
    <script type="text/babel">
        // Global helper function to edit client from map
        window.editClientFromMap = function(clientId) {
            try {
                console.log("Editing client from map:", clientId);
                const STORAGE_KEY = 'royal_tree_clients';
                const clients = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const client = clients.find(c => c.id === clientId);
                
                if (client && window.setCurrentClient && window.setIsClientModalOpen) {
                    window.setCurrentClient(client);
                    window.setIsClientModalOpen(true);
                } else {
                    console.error("Client not found or global functions unavailable");
                }
            } catch (error) {
                console.error("Error editing client from map:", error);
            }
        };
        
        // Define window properties using JSDoc
        /**
         * @typedef {Object} WindowExtensions
         * @property {function(any): void} setCurrentClient - Sets the current client
         * @property {function(boolean): void} setIsClientModalOpen - Controls client modal visibility
         */
        
        // React components
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        /**
         * @typedef {Object} Client
         * @property {string} id - Unique identifier
         * @property {string} name - Client name
         * @property {string} email - Client email
         * @property {string} phone - Client phone
         * @property {string} address - Client address
         * @property {string} serviceNeeds - Description of tree service needs
         * @property {string} locationDetails - Additional location information
         * @property {'New'|'Quote'|'Active'|'Completed'|'Inactive'} status - Current client status
         * @property {'Low'|'Medium'|'High'|'Urgent'} priority - Client priority level
         * @property {string} inquiryDate - Date of initial inquiry
         * @property {string} createdAt - Record creation timestamp
         * @property {string} updatedAt - Record update timestamp
         * @property {string} notes - Additional notes
         * @property {Object} customFields - Any additional custom fields
         */

        /**
         * @typedef {Object} ToastMessage
         * @property {string} id - Unique identifier
         * @property {string} message - Toast message content
         * @property {'success'|'error'|'warning'|'info'} type - Toast type
         * @property {number} duration - Display duration in milliseconds
         */
        
        /**
         * Database class for handling localStorage operations
         */
        const Database = (() => {
            const STORAGE_KEY = 'royal_tree_clients';
            
            /**
             * Get all clients from localStorage
             * @returns {Client[]}
             */
            const getAll = () => {
                const clients = localStorage.getItem(STORAGE_KEY);
                return clients ? JSON.parse(clients) : [];
            };
            
            /**
             * Save clients to localStorage
             * @param {Client[]} clients - Array of client objects
             */
            const saveAll = (clients) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(clients));
            };
            
            /**
             * Add a new client
             * @param {Omit<Client, 'id'|'createdAt'|'updatedAt'>} client - New client data
             * @returns {Client} - Newly created client with ID and timestamps
             */
            const add = (client) => {
                const clients = getAll();
                const newClient = {
                    ...client,
                    id: generateId(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                clients.push(newClient);
                saveAll(clients);
                return newClient;
            };
            
            /**
             * Update an existing client
             * @param {string} id - Client ID to update
             * @param {Partial<Client>} updates - Client data to update
             * @returns {Client|null} - Updated client or null if not found
             */
            const update = (id, updates) => {
                const clients = getAll();
                const index = clients.findIndex(client => client.id === id);
                if (index === -1) return null;
                
                const updatedClient = {
                    ...clients[index],
                    ...updates,
                    updatedAt: new Date().toISOString()
                };
                clients[index] = updatedClient;
                saveAll(clients);
                return updatedClient;
            };
            
            /**
             * Delete a client
             * @param {string} id - Client ID to delete
             * @returns {boolean} - Success status
             */
            const remove = (id) => {
                const clients = getAll();
                const filteredClients = clients.filter(client => client.id !== id);
                if (filteredClients.length === clients.length) return false;
                saveAll(filteredClients);
                return true;
            };
            
            /**
             * Get a single client by ID
             * @param {string} id - Client ID
             * @returns {Client|undefined} - Client data or undefined if not found
             */
            const getById = (id) => {
                const clients = getAll();
                return clients.find(client => client.id === id);
            };
            
            /**
             * Export all client data as JSON string
             * @returns {string} - JSON string of all clients
             */
            const exportData = () => {
                return localStorage.getItem(STORAGE_KEY) || '[]';
            };
            
            /**
             * Import client data from JSON string
             * @param {string} jsonData - JSON string of clients to import
             * @returns {boolean} - Success status
             */
            const importData = (jsonData) => {
                try {
                    const clients = JSON.parse(jsonData);
                    if (!Array.isArray(clients)) return false;
                    saveAll(clients);
                    return true;
                } catch (e) {
                    console.error('Import failed:', e);
                    return false;
                }
            };
            
            /**
             * Generate a unique ID
             * @returns {string} - Unique ID
             */
            const generateId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            };
            
            /**
             * Initialize with sample data if empty
             */
            const initialize = () => {
                const clients = getAll();
                if (clients.length === 0) {
                    // Add sample data
                    const sampleClients = [
                        {
                            name: 'John Smith',
                            email: 'john.smith@example.com',
                            phone: '(555) 123-4567',
                            address: '123 Oak Street, Treeville',
                            serviceNeeds: 'Tree trimming and removal',
                            locationDetails: 'Large oak in backyard, difficult access',
                            status: 'Active',
                            priority: 'Medium',
                            inquiryDate: '2023-05-15',
                            notes: 'Has used our services before, prefers weekday appointments',
                            customFields: {}
                        },
                        {
                            name: 'Sarah Johnson',
                            email: 'sarah.j@example.com',
                            phone: '(555) 987-6543',
                            address: '456 Maple Ave, Forestville',
                            serviceNeeds: 'Stump grinding',
                            locationDetails: 'Front yard, easy access',
                            status: 'Quote',
                            priority: 'Low',
                            inquiryDate: '2023-06-01',
                            notes: 'Found us through website, first-time customer',
                            customFields: {}
                        },
                        {
                            name: 'James Wilson',
                            email: 'jwilson@example.com',
                            phone: '(555) 456-7890',
                            address: '789 Pine Road, Woodland',
                            serviceNeeds: 'Emergency tree removal',
                            locationDetails: 'Fallen tree on garage',
                            status: 'New',
                            priority: 'Urgent',
                            inquiryDate: '2023-06-10',
                            notes: 'Insurance claim pending, needs immediate attention',
                            customFields: {}
                        }
                    ];
                    
                    sampleClients.forEach(client => add(client));
                }
            };
            
            return {
                getAll,
                getById,
                add,
                update,
                remove,
                exportData,
                importData,
                initialize
            };
        })();

        /**
         * Utility functions
         */
        const Utils = (() => {
            /**
             * Format a date string
             * @param {string} dateString - ISO date string
             * @returns {string} - Formatted date
             */
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                // Fix timezone issue by setting the date to noon to avoid UTC conversion problems
                const adjustedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                return new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(adjustedDate);
            };
            
            /**
             * Debounce a function
             * @param {Function} func - Function to debounce
             * @param {number} wait - Wait time in milliseconds
             * @returns {Function} - Debounced function
             */
            const debounce = (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };
            
            /**
             * Download data as a file
             * @param {string} content - File content
             * @param {string} fileName - File name
             * @param {string} contentType - MIME type
             */
            const downloadFile = (content, fileName, contentType) => {
                const a = document.createElement('a');
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            };
            
            return {
                formatDate,
                debounce,
                downloadFile
            };
        })();

        /**
         * Enhanced button click handler for tracking button interactions
         * @param {Function} handler - The original click handler
         * @param {string} buttonName - Name of the button for tracking
         * @returns {Function} - Enhanced handler function
         */
        const enhanceButtonHandler = (handler, buttonName) => {
            return (...args) => {
                console.log(`Button clicked: ${buttonName}`);
                return handler(...args);
            };
        };

        /**
         * Toast notification component
         */
        const Toast = ({ toast, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose(toast.id);
                }, toast.duration);
                
                return () => clearTimeout(timer);
            }, [toast, onClose]);
            
            return (
                <div className={`toast toast-${toast.type}`}>
                    <div className="toast-icon">
                        {toast.type === 'success' && '✅'}
                        {toast.type === 'error' && '❌'}
                        {toast.type === 'warning' && '⚠️'}
                        {toast.type === 'info' && 'ℹ️'}
                    </div>
                    <div className="toast-content">{toast.message}</div>
                    <button className="toast-close" onClick={() => onClose(toast.id)}>×</button>
                </div>
            );
        };

        /**
         * Toast container component
         */
        const ToastContainer = ({ toasts, onClose }) => {
            return (
                <div className="toast-container" role="alert" aria-live="polite">
                    {toasts.map(toast => (
                        <Toast key={toast.id} toast={toast} onClose={onClose} />
                    ))}
                </div>
            );
        };

        /**
         * Modal component
         */
        const Modal = ({ title, isOpen, onClose, children, footer }) => {
            const modalRef = useRef(null);
            
            useEffect(() => {
                if (isOpen) {
                    // Focus trap
                    const focusableElements = modalRef.current.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    const handleTabKey = (e) => {
                        if (e.key === 'Tab') {
                            if (e.shiftKey && document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            } else if (!e.shiftKey && document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    };
                    
                    const handleEscape = (e) => {
                        if (e.key === 'Escape') {
                            onClose();
                        }
                    };
                    
                    document.addEventListener('keydown', handleTabKey);
                    document.addEventListener('keydown', handleEscape);
                    
                    // Focus the first element
                    firstElement.focus();
                    
                    // Prevent scrolling on body
                    document.body.style.overflow = 'hidden';
                    
                    return () => {
                        document.removeEventListener('keydown', handleTabKey);
                        document.removeEventListener('keydown', handleEscape);
                        document.body.style.overflow = 'auto';
                    };
                }
            }, [isOpen, onClose]);
            
            if (!isOpen) return null;
            
            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div 
                        className="modal" 
                        ref={modalRef} 
                        onClick={e => e.stopPropagation()}
                        role="dialog"
                        aria-modal="true"
                        aria-labelledby="modal-title"
                    >
                        <div className="modal-header">
                            <h2 className="modal-title" id="modal-title">{title}</h2>
                            <button 
                                className="modal-close"
                                onClick={onClose}
                                aria-label="Close"
                            >
                                ×
                            </button>
                        </div>
                        <div className="modal-body">{children}</div>
                        {footer && <div className="modal-footer">{footer}</div>}
                    </div>
                </div>
            );
        };

        /**
         * Client form component
         */
        const ClientForm = ({ client, onSubmit, onCancel }) => {
            // Helper function to format date from ISO to YYYY-MM-DD for input fields
            const formatDateForInput = (dateString) => {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return ''; // Invalid date
                    return date.toISOString().split('T')[0]; // Returns YYYY-MM-DD
                } catch (error) {
                    console.error('Error formatting date:', error);
                    return '';
                }
            };

            // Helper function to extract parts from full name
            const splitName = (fullName) => {
                if (!fullName) return { firstName: '', lastName: '' };
                const parts = fullName.trim().split(' ');
                if (parts.length === 1) return { firstName: parts[0], lastName: '' };
                const lastName = parts.pop();
                const firstName = parts.join(' ');
                return { firstName, lastName };
            };

            // Helper function to extract address parts
            const parseAddress = (fullAddress) => {
                if (!fullAddress) return { 
                    streetAddress: '', 
                    town: '', 
                    province: '', 
                    postalCode: '' 
                };
                
                // Simple parsing logic
                const parts = fullAddress.split(',').map(part => part.trim());
                
                return {
                    streetAddress: parts[0] || '',
                    town: parts.length > 1 ? parts[1] : '',
                    province: parts.length > 2 ? parts[2] : '',
                    postalCode: parts.length > 3 ? parts[3] : ''
                };
            };

            // Parse existing name and address if updating a client
            const { firstName, lastName } = splitName(client?.name);
            const { streetAddress, town, province, postalCode } = parseAddress(client?.address);

            const initialFormState = {
                firstName: firstName || '',
                lastName: lastName || '',
                email: client?.email || '',
                phone: client?.phone || '',
                streetAddress: streetAddress || '',
                town: town || '',
                province: province || '',
                postalCode: postalCode || '',
                latitude: client?.latitude || '',
                longitude: client?.longitude || '',
                serviceNeeds: client?.serviceNeeds || '',
                locationDetails: client?.locationDetails || '',
                quoteAmount: client?.quoteAmount || '',
                quoteCost: client?.quoteCost || '',
                scheduledDate: formatDateForInput(client?.scheduledDate),
                status: client?.status || 'New',
                priority: client?.priority || 'Medium',
                inquiryDate: formatDateForInput(client?.inquiryDate) || formatDateForInput(new Date()),
                notes: client?.notes || '',
                customFields: client?.customFields || {},
                clientValue: client?.clientValue || "5"
            };
            
            const [formData, setFormData] = useState(initialFormState);
            const [errors, setErrors] = useState({});
            const addressInputRef = useRef(null);
            const autocompleteRef = useRef(null);
            const sessionTokenRef = useRef(null);
            
            // Initialize Google Places Autocomplete
            useEffect(() => {
                // Check if Google Maps and Places API is loaded
                if (window.google && window.google.maps && window.google.maps.places && addressInputRef.current) {
                    console.log('Initializing Places Autocomplete');
                    
                    // Create a new session token for better API usage
                    sessionTokenRef.current = new google.maps.places.AutocompleteSessionToken();
                    
                    // Initialize the autocomplete
                    autocompleteRef.current = new google.maps.places.Autocomplete(addressInputRef.current, {
                        types: ['address'],
                        componentRestrictions: { country: 'CA' },  // Restrict to Canadian addresses
                        fields: ['address_components', 'geometry', 'formatted_address', 'place_id'],
                        sessionToken: sessionTokenRef.current
                    });
                    
                    // Handle place selection
                    autocompleteRef.current.addListener('place_changed', () => {
                        const place = autocompleteRef.current.getPlace();
                        console.log('Place selected:', place);
                        
                        if (!place.geometry) {
                            console.warn('No geometry found for selected place');
                            return;
                        }
                        
                        // Extract the coordinates
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();
                        
                        // Extract address components
                        let streetNumber = '';
                        let route = '';
                        let locality = '';
                        let administrative_area_level_1 = '';
                        let postal_code = '';
                        
                        for (const component of place.address_components) {
                            const type = component.types[0];
                            
                            switch(type) {
                                case 'street_number':
                                    streetNumber = component.long_name;
                                    break;
                                case 'route':
                                    route = component.long_name;
                                    break;
                                case 'locality':
                                    locality = component.long_name;
                                    break;
                                case 'administrative_area_level_1':
                                    administrative_area_level_1 = component.long_name;
                                    break;
                                case 'postal_code':
                                    postal_code = component.long_name;
                                    break;
                            }
                        }
                        
                        // Update form data with the extracted information
                        setFormData(prev => ({
                            ...prev,
                            streetAddress: streetNumber ? `${streetNumber} ${route}` : route,
                            town: locality,
                            province: administrative_area_level_1,
                            postalCode: postal_code,
                            latitude: lat,
                            longitude: lng
                        }));
                        
                        console.log(`Address autocompleted with coordinates: [${lat}, ${lng}]`);
                    });
                }
            }, [addressInputRef.current]);
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                
                // Ensure we're only updating the specific field that changed
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
                
                // Clear error when field is changed
                if (errors[name]) {
                    setErrors(prev => ({
                        ...prev,
                        [name]: null
                    }));
                }
                
                // Log form changes to help with debugging
                console.log(`Field ${name} changed to: ${value}`);
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                // Validate first name
                if (!formData.firstName.trim()) {
                    newErrors.firstName = 'First name is required';
                }
                
                // Validate last name
                if (!formData.lastName.trim()) {
                    newErrors.lastName = 'Last name is required';
                }
                
                if (formData.email && !/^\S+@\S+\.\S+$/.test(formData.email)) {
                    newErrors.email = 'Valid email is required';
                }
                
                if (!formData.phone.trim()) {
                    newErrors.phone = 'Phone number is required';
                }

                // Validate street address
                if (!formData.streetAddress.trim()) {
                    newErrors.streetAddress = 'Street address is required';
                }

                // Detect if we have a rural address format
                const hasRuralAddressFormat = /\d+\s+(rge|range|twp|township|rd|road)\s+rd/i.test(formData.streetAddress);
                
                // Validate town/city - make it optional for rural address formats
                if (!formData.town.trim() && !hasRuralAddressFormat) {
                    newErrors.town = 'Town/City is required (or use the rural address format)';
                }
                
                // Validate coordinates if they are provided
                if (formData.latitude) {
                    const lat = parseFloat(formData.latitude);
                    if (isNaN(lat) || lat < -90 || lat > 90) {
                        newErrors.latitude = 'Latitude must be between -90 and 90';
                    }
                }
                
                if (formData.longitude) {
                    const lng = parseFloat(formData.longitude);
                    if (isNaN(lng) || lng < -180 || lng > 180) {
                        newErrors.longitude = 'Longitude must be between -180 and 180';
                    }
                }
                
                // If coordinates are partially provided (only lat or only lng)
                if ((formData.latitude && !formData.longitude) || (!formData.latitude && formData.longitude)) {
                    if (!formData.longitude) {
                        newErrors.longitude = 'Both latitude and longitude are required';
                    }
                    if (!formData.latitude) {
                        newErrors.latitude = 'Both latitude and longitude are required';
                    }
                }
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    // Create a clean copy of the form data to submit
                    const formDataToSubmit = { ...formData };
                    
                    // Combine first and last name for backward compatibility
                    formDataToSubmit.name = `${formData.firstName} ${formData.lastName}`.trim();
                    
                    // Detect rural address format
                    const isRuralAddress = /\d+\s+(rge|range|twp|township|rd|road)\s+rd/i.test(formData.streetAddress);
                    
                    // Combine address components, handling rural addresses specially
                    let addressParts;
                    
                    if (isRuralAddress) {
                        // For rural addresses, include province but town is optional
                        addressParts = [
                            formData.streetAddress,
                            formData.town, // Include town if provided
                            formData.province,
                            formData.postalCode
                        ].filter(Boolean); // Remove empty parts
                        
                        // Add 'Rural Address' metadata for display purposes
                        formDataToSubmit.isRuralAddress = true;
                        console.log('Submitting as rural address format');
                    } else {
                        // Standard address format
                        addressParts = [
                            formData.streetAddress,
                            formData.town,
                            formData.province,
                            formData.postalCode
                        ].filter(Boolean); // Remove empty parts
                    }
                    
                    formDataToSubmit.address = addressParts.join(', ');

                    // Convert latitude/longitude to numbers if they exist
                    if (formData.latitude) {
                        formDataToSubmit.latitude = parseFloat(formData.latitude);
                    }
                    
                    if (formData.longitude) {
                        formDataToSubmit.longitude = parseFloat(formData.longitude);
                    }
                    
                    // Log form submission for debugging
                    console.log('Submitting form with data:', formDataToSubmit);
                    
                    onSubmit(formDataToSubmit);
                }
            };
            
            // Geocode the address and update coordinates
            const geocodeAddress = async () => {
                try {
                    // Create a full address string
                    const fullAddress = buildAddressString();
                    console.log('Attempting to geocode address:', fullAddress);
                    
                    if (!fullAddress.trim()) {
                        alert('Please enter an address to geocode');
                        return;
                    }

                    // First, try to validate the address with the Address Validation API
                    try {
                        const result = await validateAddress(fullAddress);
                        if (result) {
                            console.log('Address validated successfully:', result);
                            // Update form fields with validated address if needed
                            if (result.geocode && result.geocode.location) {
                                const { latitude, longitude } = result.geocode.location;
                                setFormData(prev => ({
                                    ...prev,
                                    latitude: latitude,
                                    longitude: longitude
                                }));
                                console.log(`Coordinates from Address Validation: [${latitude}, ${longitude}]`);
                                return;
                            }
                        }
                    } catch (validationError) {
                        console.warn('Address validation failed, falling back to geocoding:', validationError);
                        // Continue with geocoding if validation fails
                    }
                    
                    // Fallback to geocoding if validation didn't provide coordinates
                    const geocoder = new google.maps.Geocoder();
                    
                    // Create a geocoding request with additional parameters for better accuracy
                    const request = {
                        address: fullAddress,
                        componentRestrictions: {
                            country: 'CA' // Restrict to Canada
                        },
                        region: 'ca'
                    };
                    
                    geocoder.geocode(request, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK && results && results.length > 0) {
                            const location = results[0].geometry.location;
                            console.log('Geocoding successful:', results[0]);
                            
                            // Store the place_id for future reference (can be useful for other API calls)
                            const placeId = results[0].place_id;
                            console.log('Place ID:', placeId);
                            
                            // Update the coordinates
                            setFormData(prev => ({
                                ...prev,
                                latitude: location.lat(),
                                longitude: location.lng()
                            }));
                            
                            console.log(`Retrieved coordinates: [${location.lat()}, ${location.lng()}]`);
                        } else {
                            console.error('Geocoding failed:', status);
                            alert('Could not geocode the address. Please enter coordinates manually.');
                        }
                    });
                } catch (error) {
                    console.error('Error in geocoding process:', error);
                    alert('An error occurred during geocoding. Please enter coordinates manually.');
                }
            };
            
            // Build a complete address string from the form data
            const buildAddressString = () => {
                const { streetAddress, town, province, postalCode } = formData;
                
                // Special handling for rural addresses
                const isRuralAddress = /\d+\s+(rge|range|twp|township|rd|road)\s+rd/i.test(streetAddress);
                
                // For rural addresses, we want to include any reference points we have
                // but we need less strict requirements for town
                const parts = isRuralAddress 
                    ? [
                        streetAddress?.trim(),
                        province?.trim(),
                        'Canada', // Adding country for better geocoding accuracy
                        postalCode?.trim()
                      ].filter(Boolean)
                    : [
                        streetAddress?.trim(),
                        town?.trim(),
                        province?.trim(), 
                        'Canada', // Adding country for better geocoding accuracy
                        postalCode?.trim()
                      ].filter(Boolean);
                
                const addressString = parts.join(', ');
                console.log(`Building address string: ${addressString} (rural format: ${isRuralAddress})`);
                return addressString;
            };
            
            // Validate address using Google's Address Validation API
            const validateAddress = async (addressString) => {
                try {
                    // Note: This is a placeholder for the Address Validation API call
                    // In a production environment, this would be a server-side API call
                    // For demonstration purposes, we're showing the structure
                    console.log('Address validation would call the API with:', addressString);
                    
                    // In production, you would make a fetch call like:
                    /*
                    const response = await fetch('https://addressvalidation.googleapis.com/v1:validateAddress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Goog-Api-Key': 'YOUR_API_KEY',
                            'X-Goog-FieldMask': 'result.address.formattedAddress,result.geocode.location,result.verdict.addressComplete'
                        },
                        body: JSON.stringify({
                            address: {
                                regionCode: 'CA',
                                addressLines: [addressString]
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Address validation API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.result;
                    */
                    
                    // For now, return null to fall back to geocoding
                    return null;
                } catch (error) {
                    console.error('Address validation error:', error);
                    return null;
                }
            };
            
            return (
                <form onSubmit={handleSubmit}>
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="firstName">First Name *</label>
                            <input
                                type="text"
                                id="firstName"
                                name="firstName"
                                value={formData.firstName}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.firstName ? 'true' : 'false'}
                            />
                            {errors.firstName && <div className="error-message">{errors.firstName}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="lastName">Last Name *</label>
                            <input
                                type="text"
                                id="lastName"
                                name="lastName"
                                value={formData.lastName}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.lastName ? 'true' : 'false'}
                            />
                            {errors.lastName && <div className="error-message">{errors.lastName}</div>}
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="email">Email</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                value={formData.email}
                                onChange={handleChange}
                                aria-invalid={errors.email ? 'true' : 'false'}
                            />
                            {errors.email && <div className="error-message">{errors.email}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="phone">Phone *</label>
                            <input
                                type="tel"
                                id="phone"
                                name="phone"
                                value={formData.phone}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.phone ? 'true' : 'false'}
                            />
                            {errors.phone && <div className="error-message">{errors.phone}</div>}
                        </div>
                    </div>
                    
                    <h3>Address Information</h3>
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="streetAddress">Street Address *</label>
                            <input
                                type="text"
                                id="streetAddress"
                                name="streetAddress"
                                value={formData.streetAddress}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.streetAddress ? 'true' : 'false'}
                                placeholder="123 Main St"
                                ref={addressInputRef}
                            />
                            {errors.streetAddress && <div className="error-message">{errors.streetAddress}</div>}
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="town">Town/City <span className="optional-label">(Optional for rural addresses)</span></label>
                            <input
                                type="text"
                                id="town"
                                name="town"
                                value={formData.town}
                                onChange={handleChange}
                                aria-invalid={errors.town ? 'true' : 'false'}
                                placeholder="Anytown or leave blank for rural addresses"
                            />
                            {errors.town && <div className="error-message">{errors.town}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="province">Province/State</label>
                            <select
                                id="province"
                                name="province"
                                value={formData.province}
                                onChange={handleChange}
                            >
                                <option value="">Select Province/State</option>
                                {/* Canadian Provinces */}
                                <option value="Alberta">Alberta</option>
                                <option value="British Columbia">British Columbia</option>
                                <option value="Manitoba">Manitoba</option>
                                <option value="New Brunswick">New Brunswick</option>
                                <option value="Newfoundland and Labrador">Newfoundland and Labrador</option>
                                <option value="Nova Scotia">Nova Scotia</option>
                                <option value="Ontario">Ontario</option>
                                <option value="Prince Edward Island">Prince Edward Island</option>
                                <option value="Quebec">Quebec</option>
                                <option value="Saskatchewan">Saskatchewan</option>
                                
                                {/* Canadian Territories */}
                                <option value="Northwest Territories">Northwest Territories</option>
                                <option value="Nunavut">Nunavut</option>
                                <option value="Yukon">Yukon</option>
                                
                                {/* Common US States */}
                                <option value="Alabama">Alabama</option>
                                <option value="Alaska">Alaska</option>
                                <option value="Arizona">Arizona</option>
                                <option value="California">California</option>
                                <option value="Colorado">Colorado</option>
                                <option value="Florida">Florida</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Hawaii">Hawaii</option>
                                <option value="Idaho">Idaho</option>
                                <option value="Illinois">Illinois</option>
                                <option value="Michigan">Michigan</option>
                                <option value="New York">New York</option>
                                <option value="Texas">Texas</option>
                                <option value="Washington">Washington</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="postalCode">Postal/Zip Code</label>
                            <input
                                type="text"
                                id="postalCode"
                                name="postalCode"
                                value={formData.postalCode}
                                onChange={handleChange}
                                placeholder="A1A 1A1"
                            />
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="latitude">Latitude (Optional)</label>
                            <div className="input-with-button">
                                <input
                                    type="number"
                                    id="latitude"
                                    name="latitude"
                                    value={formData.latitude || ""}
                                    onChange={handleChange}
                                    placeholder="43.651070"
                                    step="0.000001"
                                />
                            </div>
                            <small>Manually enter coordinates or use address for map placement</small>
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="longitude">Longitude (Optional)</label>
                            <div className="input-with-button">
                                <input
                                    type="number"
                                    id="longitude"
                                    name="longitude"
                                    value={formData.longitude || ""}
                                    onChange={handleChange}
                                    placeholder="-79.347015"
                                    step="0.000001"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <div className="form-coordinate-note">
                        <small>
                            <i className="info-icon">ℹ️</i> 
                            <strong>Coordinate Tips:</strong>
                            <ul>
                                <li>Enter coordinates manually or use the button below to generate them from your address.</li>
                                <li>Latitude values range from -90 to 90 (positive in North America).</li>
                                <li>Longitude values range from -180 to 180 (negative in North America).</li>
                                <li>Having accurate coordinates ensures precise map placement.</li>
                            </ul>
                        </small>
                    </div>
                    
                    <div className="form-group map-helper-buttons">
                        <button 
                            type="button" 
                            className="secondary sm"
                            onClick={geocodeAddress}
                        >
                            Get Coordinates from Address
                        </button>
                        
                        <button 
                            type="button" 
                            className="secondary sm"
                            onClick={() => {
                                // Reset the coordinates
                                setFormData(prev => ({
                                    ...prev,
                                    latitude: "",
                                    longitude: ""
                                }));
                            }}
                        >
                            Clear Coordinates
                        </button>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="status">Status</label>
                            <select
                                id="status"
                                name="status"
                                value={formData.status}
                                onChange={handleChange}
                                required
                            >
                                <option value="New">New</option>
                                <option value="Quote">Quote</option>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                            {errors.status && <div className="error-message">{errors.status}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="priority">Priority</label>
                            <select
                                id="priority"
                                name="priority"
                                value={formData.priority}
                                onChange={handleChange}
                                required
                            >
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                            {errors.priority && <div className="error-message">{errors.priority}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="clientValue">Client Value (1-10)</label>
                            <input
                                type="number"
                                id="clientValue"
                                name="clientValue"
                                min="1"
                                max="10"
                                value={formData.clientValue || "5"}
                                onChange={handleChange}
                            />
                            <small>Higher values indicate more valuable clients</small>
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="quoteAmount">Quote Amount ($)</label>
                            <input
                                type="number"
                                id="quoteAmount"
                                name="quoteAmount"
                                value={formData.quoteAmount}
                                onChange={handleChange}
                                min="0"
                                step="0.01"
                            />
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="quoteCost">Quote Cost ($)</label>
                            <input
                                type="number"
                                id="quoteCost"
                                name="quoteCost"
                                value={formData.quoteCost}
                                onChange={handleChange}
                                min="0"
                                step="0.01"
                            />
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="inquiryDate">Inquiry Date</label>
                            <input
                                type="date"
                                id="inquiryDate"
                                name="inquiryDate"
                                value={formData.inquiryDate}
                                onChange={handleChange}
                                max={new Date().toISOString().split('T')[0]} // Can't be future date
                            />
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="scheduledDate">Scheduled Work Date</label>
                            <input
                                type="date"
                                id="scheduledDate"
                                name="scheduledDate"
                                value={formData.scheduledDate}
                                onChange={handleChange}
                            />
                        </div>
                    </div>
                    
                    <div className="form-group">
                        <label htmlFor="serviceNeeds">Service Needs</label>
                        <textarea
                            id="serviceNeeds"
                            name="serviceNeeds"
                            rows="2"
                            value={formData.serviceNeeds}
                            onChange={handleChange}
                            placeholder="Describe the tree services needed"
                        ></textarea>
                    </div>
                    
                    <div className="form-group">
                        <label htmlFor="locationDetails">Location Details</label>
                        <textarea
                            id="locationDetails"
                            name="locationDetails"
                            rows="2"
                            value={formData.locationDetails}
                            onChange={handleChange}
                            placeholder="Access information, special instructions, etc."
                        ></textarea>
                    </div>
                    
                    <div className="form-group">
                        <label htmlFor="notes">Notes</label>
                        <textarea
                            id="notes"
                            name="notes"
                            rows="4"
                            value={formData.notes}
                            onChange={handleChange}
                        ></textarea>
                    </div>
                    
                    <div className="modal-footer">
                        <button type="button" onClick={onCancel} className="secondary">
                            Cancel
                        </button>
                        <button type="submit">
                            {client ? 'Update Client' : 'Add Client'}
                        </button>
                    </div>
                </form>
            );
        };

        /**
         * Dashboard component
         */
        const Dashboard = ({ clients }) => {
            // Calculate dashboard statistics
            const stats = useMemo(() => {
                const totalClients = clients.length;
                
                const statusCounts = {
                    New: 0,
                    Quote: 0,
                    Active: 0,
                    Completed: 0,
                    Inactive: 0
                };
                
                const priorityCounts = {
                    Low: 0,
                    Medium: 0,
                    High: 0,
                    Urgent: 0
                };
                
                clients.forEach(client => {
                    if (statusCounts[client.status] !== undefined) {
                        statusCounts[client.status]++;
                    }
                    
                    if (priorityCounts[client.priority] !== undefined) {
                        priorityCounts[client.priority]++;
                    }
                });
                
                return {
                    totalClients,
                    statusCounts,
                    priorityCounts
                };
            }, [clients]);
            
            return (
                <div className="dashboard">
                    <div className="stat-card">
                        <h3>Total Clients</h3>
                        <div className="stat-value">{stats.totalClients}</div>
                    </div>
                    
                    <div className="stat-card">
                        <h3>Active Clients</h3>
                        <div className="stat-value">{stats.statusCounts.Active}</div>
                    </div>
                    
                    <div className="stat-card">
                        <h3>Pending Quotes</h3>
                        <div className="stat-value">{stats.statusCounts.Quote}</div>
                    </div>
                    
                    <div className="stat-card">
                        <h3>High Priority</h3>
                        <div className="stat-value">{stats.priorityCounts.High + stats.priorityCounts.Urgent}</div>
                    </div>
                </div>
            );
        };

        /**
         * Settings form component
         */
        const SettingsForm = ({ settings, onSubmit, onCancel }) => {
            const initialFormState = {
                companyName: settings?.companyName || 'ClientTrack Pro',
                contactEmail: settings?.contactEmail || 'contact@clienttrackpro.com',
                contactPhone: settings?.contactPhone || '(555) 123-4567',
                address: settings?.address || '123 Business Ave, Suite 101',
                itemsPerPage: settings?.itemsPerPage || 10,
                defaultSort: settings?.defaultSort || 'name',
                defaultSortDirection: settings?.defaultSortDirection || 'asc',
                theme: settings?.theme || 'light',
                notificationEnabled: settings?.notificationEnabled !== undefined ? settings?.notificationEnabled : true
            };
            
            const [formData, setFormData] = useState(initialFormState);
            const [errors, setErrors] = useState({});
            
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
                
                // Clear error when field is changed
                if (errors[name]) {
                    setErrors(prev => ({
                        ...prev,
                        [name]: null
                    }));
                }
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.companyName.trim()) {
                    newErrors.companyName = 'Company name is required';
                }
                
                if (!formData.contactEmail.trim()) {
                    newErrors.contactEmail = 'Contact email is required';
                } else if (!/^\S+@\S+\.\S+$/.test(formData.contactEmail)) {
                    newErrors.contactEmail = 'Valid email is required';
                }
                
                if (!formData.contactPhone.trim()) {
                    newErrors.contactPhone = 'Contact phone is required';
                }
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    onSubmit(formData);
                }
            };
            
            return (
                <form onSubmit={handleSubmit}>
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="companyName">Company Name *</label>
                            <input
                                type="text"
                                id="companyName"
                                name="companyName"
                                value={formData.companyName}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.companyName ? 'true' : 'false'}
                            />
                            {errors.companyName && <div className="form-error">{errors.companyName}</div>}
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="contactEmail">Contact Email *</label>
                            <input
                                type="email"
                                id="contactEmail"
                                name="contactEmail"
                                value={formData.contactEmail}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.contactEmail ? 'true' : 'false'}
                            />
                            {errors.contactEmail && <div className="form-error">{errors.contactEmail}</div>}
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="contactPhone">Contact Phone *</label>
                            <input
                                type="tel"
                                id="contactPhone"
                                name="contactPhone"
                                value={formData.contactPhone}
                                onChange={handleChange}
                                aria-required="true"
                                aria-invalid={errors.contactPhone ? 'true' : 'false'}
                            />
                            {errors.contactPhone && <div className="form-error">{errors.contactPhone}</div>}
                        </div>
                    </div>
                    
                    <div className="form-group">
                        <label htmlFor="address">Business Address</label>
                        <input
                            type="text"
                            id="address"
                            name="address"
                            value={formData.address}
                            onChange={handleChange}
                        />
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="itemsPerPage">Items Per Page</label>
                            <select
                                id="itemsPerPage"
                                name="itemsPerPage"
                                value={formData.itemsPerPage}
                                onChange={handleChange}
                            >
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="theme">Theme</label>
                            <select
                                id="theme"
                                name="theme"
                                value={formData.theme}
                                onChange={handleChange}
                            >
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="forest">Forest</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label htmlFor="defaultSort">Default Sort Field</label>
                            <select
                                id="defaultSort"
                                name="defaultSort"
                                value={formData.defaultSort}
                                onChange={handleChange}
                            >
                                <option value="name">Name</option>
                                <option value="phone">Phone</option>
                                <option value="status">Status</option>
                                <option value="priority">Priority</option>
                                <option value="inquiryDate">Inquiry Date</option>
                            </select>
                        </div>
                        
                        <div className="form-group">
                            <label htmlFor="defaultSortDirection">Default Sort Direction</label>
                            <select
                                id="defaultSortDirection"
                                name="defaultSortDirection"
                                value={formData.defaultSortDirection}
                                onChange={handleChange}
                            >
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="form-group">
                        <label className="checkbox-label">
                            <input
                                type="checkbox"
                                name="notificationEnabled"
                                checked={formData.notificationEnabled}
                                onChange={handleChange}
                            />
                            Enable Notifications
                        </label>
                    </div>
                    
                    <div className="modal-footer">
                        <button type="button" onClick={onCancel} className="secondary">
                            Cancel
                        </button>
                        <button type="submit">
                            Save Settings
                        </button>
                    </div>
                </form>
            );
        };

        /**
         * Reports component
         */
        const ReportsComponent = ({ clients, onClose }) => {
            const [reportType, setReportType] = useState('status');
            const [dateRange, setDateRange] = useState('all');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [generatedReport, setGeneratedReport] = useState(null);
            
            // Calculate report data
            const generateReport = () => {
                let filteredClients = [...clients];
                
                // Apply date filter if custom range is selected
                if (dateRange === 'custom' && startDate && endDate) {
                    filteredClients = filteredClients.filter(client => {
                        const inquiryDate = new Date(client.inquiryDate);
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999); // Include the entire end day
                        
                        return inquiryDate >= start && inquiryDate <= end;
                    });
                } else if (dateRange === 'month') {
                    // Last 30 days
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    filteredClients = filteredClients.filter(client => {
                        const inquiryDate = new Date(client.inquiryDate);
                        return inquiryDate >= thirtyDaysAgo;
                    });
                } else if (dateRange === 'quarter') {
                    // Last 90 days
                    const ninetyDaysAgo = new Date();
                    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                    
                    filteredClients = filteredClients.filter(client => {
                        const inquiryDate = new Date(client.inquiryDate);
                        return inquiryDate >= ninetyDaysAgo;
                    });
                } else if (dateRange === 'year') {
                    // Last 365 days
                    const yearAgo = new Date();
                    yearAgo.setDate(yearAgo.getDate() - 365);
                    
                    filteredClients = filteredClients.filter(client => {
                        const inquiryDate = new Date(client.inquiryDate);
                        return inquiryDate >= yearAgo;
                    });
                }
                
                // Generate report based on type
                let reportData = {};
                
                if (reportType === 'status') {
                    reportData = {
                        title: 'Client Status Report',
                        labels: ['New', 'Quote', 'Active', 'Completed', 'Inactive'],
                        data: [0, 0, 0, 0, 0],
                        total: filteredClients.length
                    };
                    
                    filteredClients.forEach(client => {
                        switch (client.status) {
                            case 'New': reportData.data[0]++; break;
                            case 'Quote': reportData.data[1]++; break;
                            case 'Active': reportData.data[2]++; break;
                            case 'Completed': reportData.data[3]++; break;
                            case 'Inactive': reportData.data[4]++; break;
                            default: break;
                        }
                    });
                } else if (reportType === 'priority') {
                    reportData = {
                        title: 'Client Priority Report',
                        labels: ['Low', 'Medium', 'High', 'Urgent'],
                        data: [0, 0, 0, 0],
                        total: filteredClients.length
                    };
                    
                    filteredClients.forEach(client => {
                        switch (client.priority) {
                            case 'Low': reportData.data[0]++; break;
                            case 'Medium': reportData.data[1]++; break;
                            case 'High': reportData.data[2]++; break;
                            case 'Urgent': reportData.data[3]++; break;
                            default: break;
                        }
                    });
                } else if (reportType === 'service') {
                    // Group by service needs (simplified)
                    const serviceGroups = {};
                    
                    filteredClients.forEach(client => {
                        const service = client.serviceNeeds || 'Unspecified';
                        if (!serviceGroups[service]) {
                            serviceGroups[service] = 0;
                        }
                        serviceGroups[service]++;
                    });
                    
                    const labels = Object.keys(serviceGroups);
                    const data = labels.map(label => serviceGroups[label]);
                    
                    reportData = {
                        title: 'Service Type Report',
                        labels,
                        data,
                        total: filteredClients.length
                    };
                }
                
                setGeneratedReport(reportData);
            };
            
            // Handle form submission
            const handleSubmit = (e) => {
                e.preventDefault();
                generateReport();
            };
            
            // Export report as CSV
            const exportReportCSV = () => {
                if (!generatedReport) return;
                
                let csvContent = `${generatedReport.title}\n\n`;
                csvContent += `Category,Count,Percentage\n`;
                
                generatedReport.labels.forEach((label, index) => {
                    const count = generatedReport.data[index];
                    const percentage = generatedReport.total > 0 
                        ? ((count / generatedReport.total) * 100).toFixed(2) 
                        : '0.00';
                    csvContent += `${label},${count},${percentage}%\n`;
                });
                
                csvContent += `\nTotal,${generatedReport.total},100%\n`;
                
                // Add date range info
                const today = new Date().toISOString().split('T')[0];
                csvContent += `\nReport generated on,${today}\n`;
                
                if (dateRange === 'custom' && startDate && endDate) {
                    csvContent += `Date range,${startDate} to ${endDate}\n`;
                } else if (dateRange === 'month') {
                    csvContent += `Date range,Last 30 days\n`;
                } else if (dateRange === 'quarter') {
                    csvContent += `Date range,Last 90 days\n`;
                } else if (dateRange === 'year') {
                    csvContent += `Date range,Last 365 days\n`;
                } else {
                    csvContent += `Date range,All time\n`;
                }
                
                Utils.downloadFile(csvContent, `${generatedReport.title.toLowerCase().replace(/\s+/g, '-')}-${today}.csv`, 'text/csv');
            };
            
            return (
                <div className="reports-container">
                    <form onSubmit={handleSubmit}>
                        <div className="form-row">
                            <div className="form-group">
                                <label htmlFor="reportType">Report Type</label>
                                <select
                                    id="reportType"
                                    value={reportType}
                                    onChange={(e) => setReportType(e.target.value)}
                                >
                                    <option value="status">Client Status</option>
                                    <option value="priority">Client Priority</option>
                                    <option value="service">Service Types</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label htmlFor="dateRange">Date Range</label>
                                <select
                                    id="dateRange"
                                    value={dateRange}
                                    onChange={(e) => setDateRange(e.target.value)}
                                >
                                    <option value="all">All Time</option>
                                    <option value="month">Last 30 Days</option>
                                    <option value="quarter">Last 90 Days</option>
                                    <option value="year">Last 365 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                        </div>
                        
                        {dateRange === 'custom' && (
                            <div className="form-row">
                                <div className="form-group">
                                    <label htmlFor="startDate">Start Date</label>
                                    <input
                                        type="date"
                                        id="startDate"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        required
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label htmlFor="endDate">End Date</label>
                                    <input
                                        type="date"
                                        id="endDate"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        min={startDate}
                                        required
                                    />
                                </div>
                            </div>
                        )}
                        
                        <div className="form-group">
                            <button type="submit">Generate Report</button>
                        </div>
                    </form>
                    
                    {generatedReport && (
                        <div className="report-results">
                            <h3>{generatedReport.title}</h3>
                            
                            <div className="report-summary">
                                <p>Total clients: <strong>{generatedReport.total}</strong></p>
                                
                                {dateRange === 'custom' && startDate && endDate && (
                                    <p>Date range: <strong>{startDate} to {endDate}</strong></p>
                                )}
                                {dateRange === 'month' && (
                                    <p>Date range: <strong>Last 30 days</strong></p>
                                )}
                                {dateRange === 'quarter' && (
                                    <p>Date range: <strong>Last 90 days</strong></p>
                                )}
                                {dateRange === 'year' && (
                                    <p>Date range: <strong>Last 365 days</strong></p>
                                )}
                                {dateRange === 'all' && (
                                    <p>Date range: <strong>All time</strong></p>
                                )}
                            </div>
                            
                            <table className="report-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {generatedReport.labels.map((label, index) => {
                                        const count = generatedReport.data[index];
                                        const percentage = generatedReport.total > 0 
                                            ? ((count / generatedReport.total) * 100).toFixed(2) 
                                            : '0.00';
                                        
                                        return (
                                            <tr key={label}>
                                                <td>{label}</td>
                                                <td>{count}</td>
                                                <td>{percentage}%</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            
                            <div className="report-actions">
                                <button onClick={exportReportCSV} className="secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M17 8L12 3M12 3L7 8M12 3V15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Export CSV
                                </button>
                            </div>
                        </div>
                    )}
                    
                    <div className="modal-footer">
                        <button onClick={onClose} className="secondary">Close</button>
                    </div>
                </div>
            );
        };

        /**
         * Main application component
         */
        const App = () => {
            // State for clients
            const [clients, setClients] = useState([]);
            const [filteredClients, setFilteredClients] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'asc' });
            
            // State for modals
            const [isClientModalOpen, setIsClientModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [isReportsModalOpen, setIsReportsModalOpen] = useState(false);
            const [isClientsModalOpen, setIsClientsModalOpen] = useState(false);
            const [isPriorityMatrixModalOpen, setIsPriorityMatrixModalOpen] = useState(false);
            const [isFinancialForecasterModalOpen, setIsFinancialForecasterModalOpen] = useState(false);
            const [currentClient, setCurrentClient] = useState(null);
            
            // State for settings
            const [settings, setSettings] = useState({
                companyName: 'ClientTrack Pro',
                contactEmail: 'info@clienttrackpro.com',
                contactPhone: '(555) 123-4567',
                address: '123 Business Ave, Suite 101',
                theme: 'light',
                itemsPerPage: 10,
                defaultSort: 'name',
                defaultSortDirection: 'asc',
                notificationEnabled: true
            });
            
            // State for toasts
            const [toasts, setToasts] = useState([]);
            
            // Expose functions to window for ClientsModal
            window.setCurrentClient = setCurrentClient;
            window.setIsClientModalOpen = setIsClientModalOpen;
            
            // Initialize database
            useEffect(() => {
                console.log('Initializing application...');
                Database.initialize();
                loadClients();
                loadSettings();
                
                // Log successful initialization
                console.log('Application initialized successfully');
                showToast('Application loaded successfully', 'success');
            }, []);
            
            // Load clients from database
            const loadClients = () => {
                console.log('Loading clients from database...');
                const allClients = Database.getAll();
                console.log(`Loaded ${allClients.length} clients`);
                setClients(allClients);
            };
            
            // Load settings from database
            const loadSettings = () => {
                const savedSettings = JSON.parse(localStorage.getItem('royal_tree_settings')) || {
                    theme: 'light',
                    itemsPerPage: 10,
                    defaultSort: 'name',
                    defaultSortDirection: 'asc'
                };
                
                setSettings(savedSettings);
                
                // Apply theme from settings
                if (savedSettings.theme) {
                    document.documentElement.setAttribute('data-theme', savedSettings.theme);
                }
                
                // Apply items per page from settings
                if (savedSettings.itemsPerPage) {
                    setItemsPerPage(parseInt(savedSettings.itemsPerPage));
                }
                
                // Apply default sort from settings
                if (savedSettings.defaultSort && savedSettings.defaultSortDirection) {
                    setSortConfig({
                        key: savedSettings.defaultSort,
                        direction: savedSettings.defaultSortDirection
                    });
                }
            };
            
            // Save settings to localStorage
            const saveSettings = (newSettings) => {
                localStorage.setItem('royal_tree_settings', JSON.stringify(newSettings));
                setSettings(newSettings);
                
                // Apply settings
                setItemsPerPage(parseInt(newSettings.itemsPerPage));
                setSortConfig({
                    key: newSettings.defaultSort,
                    direction: newSettings.defaultSortDirection
                });
                
                // Apply theme
                document.body.className = newSettings.theme;
                
                setIsSettingsModalOpen(false);
                showToast('Settings saved successfully', 'success');
            };
            
            // Filter and sort clients
            useEffect(() => {
                let filtered = [...clients];
                
                // Apply search filter
                if (searchTerm) {
                    const lowercaseSearch = searchTerm.toLowerCase();
                    filtered = filtered.filter(client => 
                        client.name.toLowerCase().includes(lowercaseSearch) ||
                        client.email.toLowerCase().includes(lowercaseSearch) ||
                        client.phone.toLowerCase().includes(lowercaseSearch) ||
                        client.notes.toLowerCase().includes(lowercaseSearch)
                    );
                }
                
                // Apply sorting
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) {
                            return sortConfig.direction === 'asc' ? -1 : 1;
                        }
                        if (a[sortConfig.key] > b[sortConfig.key]) {
                            return sortConfig.direction === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                
                setFilteredClients(filtered);
                setCurrentPage(1);
            }, [clients, searchTerm, sortConfig]);
            
            // Show toast notification
            const showToast = (message, type = 'info', duration = 3000) => {
                const id = Date.now().toString();
                const toast = { id, message, type, duration };
                setToasts(prev => [...prev, toast]);
                return id;
            };
            
            // Close toast notification
            const closeToast = (id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            };
            
            // Handle sort
            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };
            
            // Handle search
            const handleSearch = (e) => {
                setSearchTerm(e.target.value);
            };
            
            // Handle client form submission
            const handleClientSubmit = (formData) => {
                console.log('Submitting client form data:', formData);
                
                // Create a clean copy of form data to prevent reference issues
                const clientData = { ...formData };
                
                // Validate dates to ensure they're in proper format
                if (clientData.scheduledDate) {
                    // Ensure date is valid
                    try {
                        const date = new Date(clientData.scheduledDate);
                        if (!isNaN(date.getTime())) {
                            // Valid date, normalize to ISO format if needed
                            clientData.scheduledDate = clientData.scheduledDate;
                        } else {
                            console.error('Invalid scheduled date format:', clientData.scheduledDate);
                            showToast('Invalid scheduled date format', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error processing scheduled date:', error);
                        showToast('Error processing scheduled date', 'error');
                        return;
                    }
                }
                
                // Also validate inquiry date
                if (clientData.inquiryDate) {
                    try {
                        const date = new Date(clientData.inquiryDate);
                        if (!isNaN(date.getTime())) {
                            // Valid date, normalize to ISO format if needed
                            clientData.inquiryDate = clientData.inquiryDate;
                        } else {
                            console.error('Invalid inquiry date format:', clientData.inquiryDate);
                            showToast('Invalid inquiry date format', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error processing inquiry date:', error);
                        showToast('Error processing inquiry date', 'error');
                        return;
                    }
                } else {
                    // If no inquiry date is provided, use the current date
                    clientData.inquiryDate = new Date().toISOString().split('T')[0];
                }
                
                if (currentClient) {
                    // Update existing client
                    const updated = Database.update(currentClient.id, clientData);
                    if (updated) {
                        loadClients();
                        showToast('Client updated successfully', 'success');
                        setIsClientModalOpen(false);
                        setCurrentClient(null); // Clear current client
                    } else {
                        showToast('Failed to update client', 'error');
                    }
                } else {
                    // Add new client
                    const added = Database.add(clientData);
                    if (added) {
                        loadClients();
                        showToast('Client added successfully', 'success');
                        setIsClientModalOpen(false);
                    } else {
                        showToast('Failed to add client', 'error');
                    }
                }
            };
            
            // Handle delete confirmation
            const handleDeleteConfirm = () => {
                if (currentClient) {
                    console.log(`Deleting client: ${currentClient.name} (ID: ${currentClient.id})`);
                    
                    const deleted = Database.remove(currentClient.id);
                    if (deleted) {
                        loadClients();
                        showToast('Client deleted successfully', 'success');
                    } else {
                        showToast('Failed to delete client', 'error');
                    }
                    setIsDeleteModalOpen(false);
                }
            };
            
            // Handle export data
            const handleExport = () => {
                console.log('Exporting client data...');
                const data = Database.exportData();
                console.log(`Exporting ${JSON.parse(data).length} client records`);
                Utils.downloadFile(data, 'royal-tree-clients.json', 'application/json');
                showToast('Data exported successfully', 'success');
            };
            
            // Handle import data
            const handleImport = () => {
                console.log('Initiating import process...');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        console.log('No file selected for import');
                        return;
                    }
                    
                    console.log(`Selected file: ${file.name}, size: ${file.size} bytes`);
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            console.log('File loaded, attempting to parse and import...');
                            const jsonData = event.target.result;
                            const recordCount = JSON.parse(jsonData).length;
                            console.log(`Importing ${recordCount} client records`);
                            
                            const imported = Database.importData(jsonData);
                            if (imported) {
                                loadClients();
                                showToast(`Imported ${recordCount} client records successfully`, 'success');
                            } else {
                                showToast('Failed to import data', 'error');
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            showToast('Invalid file format', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            };
            
            // Pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredClients.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredClients.length / itemsPerPage);
            
            const paginate = (pageNumber) => setCurrentPage(pageNumber);
            
            // Handle navigation clicks
            const handleNavClick = (e, section) => {
                e.preventDefault();
                
                if (section === 'settings') {
                    setIsSettingsModalOpen(true);
                } else if (section === 'reports') {
                    setIsReportsModalOpen(true);
                } else if (section === 'clients') {
                    setIsClientsModalOpen(true);
                } else if (section === 'financials') {
                    setIsFinancialForecasterModalOpen(true);
                }
            };
            
            // Generate events from clients
            const events = useMemo(() => {
                // Create client events
                const clientEvents = clients
                    .filter(client => client.scheduledDate) // Only include clients with scheduled dates
                    .map(client => {
                        // Fix timezone issue by parsing the date correctly
                        const dateObj = new Date(client.scheduledDate);
                        // Create date at noon to avoid timezone issues
                        const adjustedDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12, 0, 0);
                        
                        return {
                            id: `scheduled-${client.id}`,
                            title: `${client.name} - ${client.serviceNeeds || 'Scheduled Work'}`,
                            start: adjustedDate,
                            end: adjustedDate,
                            client: client,
                            type: 'scheduled',
                            priority: client.priority
                        };
                    });
                
                // Combine client events with Google Calendar events
                return [...clientEvents, ...googleCalendarEvents];
            }, [clients, googleCalendarEvents]);
            
            // Create Google Calendar event for a client
            const handleCreateGoogleEvent = async (client) => {
                if (!isCalendarAuthorized) {
                    alert('Please authorize access to Google Calendar first');
                    return;
                }
                
                setIsAddingGoogleEvent(true);
                
                try {
                    // Format date for event
                    const eventDate = client.scheduledDate ? new Date(client.scheduledDate) : new Date();
                    
                    // Set event start and end times (1 hour duration by default)
                    const startTime = new Date(eventDate);
                    startTime.setHours(9, 0, 0); // Default to 9 AM
                    
                    const endTime = new Date(startTime);
                    endTime.setHours(startTime.getHours() + 1); // 1 hour appointment
                    
                    const appointmentDetails = {
                        service: client.serviceNeeds || '',
                        notes: client.notes || '',
                        startTime: startTime.toISOString(),
                        endTime: endTime.toISOString()
                    };
                    
                    const result = await createClientEvent(client, appointmentDetails);
                    
                    if (result) {
                        alert(`Appointment created for ${client.name}`);
                        fetchGoogleCalendarEvents(); // Refresh calendar
                    }
                } catch (error) {
                    console.error('Error creating Google Calendar event:', error);
                    alert('Failed to create calendar event. Please try again.');
                } finally {
                    setIsAddingGoogleEvent(false);
                }
            };
            
            // Handle navigation
            const handlePrevious = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') {
                    newDate.setMonth(newDate.getMonth() - 1);
                } else if (viewMode === 'week') {
                    newDate.setDate(newDate.getDate() - 7);
                } else if (viewMode === 'day') {
                    newDate.setDate(newDate.getDate() - 1);
                }
                setCurrentDate(newDate);
            };
            
            const handleNext = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') {
                    newDate.setMonth(newDate.getMonth() + 1);
                } else if (viewMode === 'week') {
                    newDate.setDate(newDate.getDate() + 7);
                } else if (viewMode === 'day') {
                    newDate.setDate(newDate.getDate() + 1);
                }
                setCurrentDate(newDate);
            };
            
            const handleToday = () => {
                setCurrentDate(new Date());
            };
            
            // Format date display
            const formatDateDisplay = () => {
                if (viewMode === 'month') {
                    return new Intl.DateTimeFormat('en-US', { 
                        year: 'numeric', 
                        month: 'long' 
                    }).format(currentDate);
                } else if (viewMode === 'week') {
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    
                    return `${new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' }).format(startOfWeek)} - ${new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(endOfWeek)}`;
                } else if (viewMode === 'day') {
                    return new Intl.DateTimeFormat('en-US', { 
                        weekday: 'long',
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }).format(currentDate);
                }
            };
            
            // Handle event click
            const handleEventClick = (event) => {
                setSelectedEvent(event);
                setIsEventModalOpen(true);
            };
            
            // Generate days for month view
            const generateMonthDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                // First day of the month
                const firstDay = new Date(year, month, 1);
                // Last day of the month
                const lastDay = new Date(year, month + 1, 0);
                
                // Start from the previous month's days that appear in the first week
                const startDay = new Date(firstDay);
                startDay.setDate(startDay.getDate() - startDay.getDay());
                
                // End with the next month's days that appear in the last week
                const endDay = new Date(lastDay);
                endDay.setDate(endDay.getDate() + (6 - endDay.getDay()));
                
                const days = [];
                let currentDay = new Date(startDay);
                
                while (currentDay <= endDay) {
                    days.push(new Date(currentDay));
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                
                return days;
            };
            
            // Filter events for a specific day
            const getEventsForDay = (day) => {
                return events.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate.getDate() === day.getDate() && 
                           eventDate.getMonth() === day.getMonth() && 
                           eventDate.getFullYear() === day.getFullYear();
                });
            };
            
            // Render month view
            const renderMonthView = () => {
                const days = generateMonthDays();
                
                return (
                    <div className="calendar-month-view">
                        <div className="calendar-weekdays">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                <div key={day} className="calendar-weekday">{day}</div>
                            ))}
                        </div>
                        <div className="calendar-days">
                            {days.map((day, index) => {
                                const isToday = day.toDateString() === new Date().toDateString();
                                const isDifferentMonth = day.getMonth() !== currentDate.getMonth();
                                const dayEvents = getEventsForDay(day);
                                
                                return (
                                    <div 
                                        key={index} 
                                        className={`calendar-day ${isToday ? 'today' : ''} ${isDifferentMonth ? 'different-month' : ''}`}
                                    >
                                        <div className="calendar-day-header">{day.getDate()}</div>
                                        <div className="calendar-day-events">
                                            {dayEvents.map(event => (
                                                <div 
                                                    key={event.id} 
                                                    className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                                    onClick={() => handleEventClick(event)}
                                                >
                                                    {event.title}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            // Render week view
            const renderWeekView = () => {
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                
                const days = Array.from({ length: 7 }, (_, i) => {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    return day;
                });
                
                return (
                    <div className="calendar-week-view">
                        <div className="calendar-weekdays">
                            {days.map((day, index) => {
                                const isToday = day.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div key={index} className={`calendar-weekday ${isToday ? 'today' : ''}`}>
                                        <div>{new Intl.DateTimeFormat('en-US', { weekday: 'short' }).format(day)}</div>
                                        <div>{day.getDate()}</div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="calendar-week-body">
                            {days.map((day, dayIndex) => {
                                const dayEvents = getEventsForDay(day);
                                const isToday = day.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div key={dayIndex} className={`calendar-week-column ${isToday ? 'today' : ''}`}>
                                        {dayEvents.map(event => (
                                            <div 
                                                key={event.id} 
                                                className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                                onClick={() => handleEventClick(event)}
                                            >
                                                {event.title}
                                            </div>
                                        ))}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            // Render day view
            const renderDayView = () => {
                const dayEvents = getEventsForDay(currentDate);
                
                return (
                    <div className="calendar-day-view">
                        <div className="calendar-day-header">
                            <h3>{new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(currentDate)}</h3>
                        </div>
                        <div className="calendar-day-body">
                            {dayEvents.length > 0 ? (
                                dayEvents.map(event => (
                                    <div 
                                        key={event.id} 
                                        className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                        onClick={() => handleEventClick(event)}
                                    >
                                        <div className="event-title">{event.title}</div>
                                    </div>
                                ))
                            ) : (
                                <div className="no-events">No events scheduled for this day</div>
                            )}
                        </div>
                    </div>
                );
            };
            
            return (
                <>
                    <a href="#main" className="skip-link">Skip to main content</a>
                    
                    <header>
                        <div className="container header-content">
                            <div className="logo">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 22V18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M12 18C14.7614 18 17 15.7614 17 13C17 10.2386 14.7614 8 12 8C9.23858 8 7 10.2386 7 13C7 15.7614 9.23858 18 12 18Z" fill="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M4.92999 19.07C3.12999 17.27 2 14.76 2 12C2 6.48 6.48 2 12 2C17.52 2 22 6.48 22 12C22 14.76 20.87 17.27 19.07 19.07" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                                ClientTrack Pro
                            </div>
                            
                            <nav>
                                <ul>
                                    <li>
                                        <a href="#" onClick={(e) => handleNavClick(e, 'clients')}>Clients</a>
                                    </li>
                                    <li>
                                        <a href="#" onClick={(e) => handleNavClick(e, 'reports')}>Reports</a>
                                    </li>
                                    <li>
                                        <a href="#" onClick={(e) => handleNavClick(e, 'financials')}>Financials</a>
                                    </li>
                                    <li>
                                        <a href="#" onClick={(e) => handleNavClick(e, 'settings')}>Settings</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </header>
                    
                    <main id="main" className="container">
                        <h1>Client Tracker</h1>
                        
                        <Dashboard clients={clients} />
                        
                        <div className="controls">
                            <div className="search-bar">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M21 21L16.65 16.65" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                                <input 
                                    type="text" 
                                    placeholder="Search clients..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    aria-label="Search clients"
                                />
                            </div>
                            
                            <div className="action-buttons">
                                <button onClick={() => setIsClientModalOpen(true)}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 5V19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M5 12H19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Add Client
                                </button>
                                <button onClick={() => setIsPriorityMatrixModalOpen(true)}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 18H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M3 18H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M8 12H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M3 12H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M8 6H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M3 6H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Priority Matrix
                                </button>
                                <button onClick={() => setIsFinancialForecasterModalOpen(true)}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 20V10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M12 20V4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M6 20V14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Financial Forecast
                                </button>
                                <button onClick={handleExport} className="secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M7 10L12 15L17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M12 15V3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Export
                                </button>
                                <button onClick={handleImport} className="secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M7 10L12 5L17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        <path d="M12 5V17" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Import
                                </button>
                            </div>
                        </div>
                        
                        <ClientPriorityDashboard clients={clients} />
                        
                        {/* Add the WorkCalendar below the ClientPriorityDashboard */}
                        <WorkCalendar clients={filteredClients} />
                        
                        {/* Add the ClientMap below the WorkCalendar */}
                        <ClientMap clients={filteredClients} />
                        
                        <div className="table-container">
                            <table aria-label="Clients table">
                                <thead>
                                    <tr>
                                        <th 
                                            onClick={() => handleSort('name')}
                                            className={sortConfig.key === 'name' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'name' ? sortConfig.direction : 'none'}
                                        >
                                            Name
                                        </th>
                                        <th 
                                            onClick={() => handleSort('phone')}
                                            className={sortConfig.key === 'phone' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'phone' ? sortConfig.direction : 'none'}
                                        >
                                            Phone
                                        </th>
                                        <th 
                                            onClick={() => handleSort('status')}
                                            className={sortConfig.key === 'status' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'status' ? sortConfig.direction : 'none'}
                                        >
                                            Status
                                        </th>
                                        <th 
                                            onClick={() => handleSort('priority')}
                                            className={sortConfig.key === 'priority' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'priority' ? sortConfig.direction : 'none'}
                                        >
                                            Priority
                                        </th>
                                        <th 
                                            onClick={() => handleSort('quoteAmount')}
                                            className={sortConfig.key === 'quoteAmount' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'quoteAmount' ? sortConfig.direction : 'none'}
                                        >
                                            Quote Amount
                                        </th>
                                        <th 
                                            onClick={() => handleSort('scheduledDate')}
                                            className={sortConfig.key === 'scheduledDate' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'scheduledDate' ? sortConfig.direction : 'none'}
                                        >
                                            Scheduled Date
                                        </th>
                                        <th 
                                            onClick={() => handleSort('inquiryDate')}
                                            className={sortConfig.key === 'inquiryDate' ? sortConfig.direction : ''}
                                            aria-sort={sortConfig.key === 'inquiryDate' ? sortConfig.direction : 'none'}
                                        >
                                            Inquiry Date
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {currentItems.length > 0 ? (
                                        currentItems.map(client => (
                                            <tr key={client.id} className={`priority-${client.priority.toLowerCase()}`}>
                                                <td>{client.name}</td>
                                                <td>{client.phone}</td>
                                                <td>
                                                    <span className={`status-badge status-${client.status.toLowerCase()}`}>
                                                        {client.status}
                                                    </span>
                                                </td>
                                                <td>{client.priority}</td>
                                                <td>{client.quoteAmount ? `$${parseFloat(client.quoteAmount).toFixed(2)}` : '-'}</td>
                                                <td>{client.scheduledDate ? Utils.formatDate(client.scheduledDate) : '-'}</td>
                                                <td>{Utils.formatDate(client.inquiryDate)}</td>
                                                <td>
                                                    <div className="action-buttons">
                                                        <button 
                                                            className="sm"
                                                            onClick={() => {
                                                                setCurrentClient(client);
                                                                setIsClientModalOpen(true);
                                                            }}
                                                            aria-label={`Edit ${client.name}`}
                                                        >
                                                            Edit
                                                        </button>
                                                        <button 
                                                            className="sm danger"
                                                            onClick={() => {
                                                                setCurrentClient(client);
                                                                setIsDeleteModalOpen(true);
                                                            }}
                                                            aria-label={`Delete ${client.name}`}
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan="8" style={{ textAlign: 'center' }}>
                                                {clients.length === 0 
                                                    ? 'No clients found. Add your first client!' 
                                                    : 'No clients match your search.'}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                        
                        {totalPages > 1 && (
                            <div className="pagination" role="navigation" aria-label="Pagination">
                                <button 
                                    onClick={() => paginate(1)}
                                    disabled={currentPage === 1}
                                    aria-label="Go to first page"
                                >
                                    ⟪
                                </button>
                                <button 
                                    onClick={() => paginate(currentPage - 1)}
                                    disabled={currentPage === 1}
                                    aria-label="Go to previous page"
                                >
                                    ⟨
                                </button>
                                
                                {[...Array(totalPages)].map((_, index) => {
                                    const pageNumber = index + 1;
                                    // Show limited page numbers
                                    if (
                                        pageNumber === 1 ||
                                        pageNumber === totalPages ||
                                        (pageNumber >= currentPage - 1 && pageNumber <= currentPage + 1)
                                    ) {
                                        return (
                                            <button
                                                key={pageNumber}
                                                onClick={() => paginate(pageNumber)}
                                                className={currentPage === pageNumber ? 'active' : ''}
                                                aria-label={`Page ${pageNumber}`}
                                                aria-current={currentPage === pageNumber ? 'page' : undefined}
                                            >
                                                {pageNumber}
                                            </button>
                                        );
                                    } else if (
                                        (pageNumber === currentPage - 2 && currentPage > 3) ||
                                        (pageNumber === currentPage + 2 && currentPage < totalPages - 2)
                                    ) {
                                        return <span key={pageNumber}>...</span>;
                                    }
                                    return null;
                                })}
                                
                                <button 
                                    onClick={() => paginate(currentPage + 1)}
                                    disabled={currentPage === totalPages}
                                    aria-label="Go to next page"
                                >
                                    ⟩
                                </button>
                                <button 
                                    onClick={() => paginate(totalPages)}
                                    disabled={currentPage === totalPages}
                                    aria-label="Go to last page"
                                >
                                    ⟫
                                </button>
                            </div>
                        )}
                    </main>
                    
                    <footer>
                        <div className="container">
                            <p>&copy; {new Date().getFullYear()} ClientTrack Pro. All rights reserved.</p>
                        </div>
                    </footer>
                    
                    {/* Client Modal */}
                    <Modal
                        title={currentClient ? 'Edit Client' : 'Add New Client'}
                        isOpen={isClientModalOpen}
                        onClose={() => {
                            console.log('Closing client modal and cleaning up');
                            setIsClientModalOpen(false);
                            setCurrentClient(null);
                        }}
                        children={
                            <ClientForm 
                                client={currentClient}
                                onSubmit={handleClientSubmit}
                                onCancel={() => {
                                    console.log('Cancelling client form and cleaning up');
                                    setIsClientModalOpen(false);
                                    setCurrentClient(null);
                                }}
                            />
                        }
                    />
                    
                    {/* Delete Confirmation Modal */}
                    <Modal
                        title="Confirm Delete"
                        isOpen={isDeleteModalOpen}
                        onClose={() => setIsDeleteModalOpen(false)}
                        children={
                            <div>
                                <p>Are you sure you want to delete {currentClient?.name}?</p>
                                <p>This action cannot be undone.</p>
                            </div>
                        }
                        footer={
                            <div className="modal-footer">
                                <button onClick={() => setIsDeleteModalOpen(false)} className="secondary">
                                    Cancel
                                </button>
                                <button onClick={handleDeleteConfirm} className="danger">
                                    Delete
                                </button>
                            </div>
                        }
                    />
                    
                    {/* Settings Modal */}
                    <Modal
                        title="Settings"
                        isOpen={isSettingsModalOpen}
                        onClose={() => setIsSettingsModalOpen(false)}
                        children={
                            <SettingsForm 
                                settings={settings}
                                onSubmit={saveSettings}
                                onCancel={() => setIsSettingsModalOpen(false)}
                            />
                        }
                    />
                    
                    {/* Reports Modal */}
                    <Modal
                        title="Reports"
                        isOpen={isReportsModalOpen}
                        onClose={() => setIsReportsModalOpen(false)}
                        children={
                            <ReportsComponent
                                clients={clients}
                                onClose={() => setIsReportsModalOpen(false)}
                            />
                        }
                    />
                    
                    {/* Clients Modal */}
                    <Modal
                        title="Client Management"
                        isOpen={isClientsModalOpen}
                        onClose={() => setIsClientsModalOpen(false)}
                        children={
                            <div className="clients-modal-content">
                                <p>This modal would contain advanced client management features.</p>
                            </div>
                        }
                        footer={
                            <div className="modal-footer">
                                <button onClick={() => setIsClientsModalOpen(false)}>Close</button>
                            </div>
                        }
                    />
                    
                    {/* Priority Matrix Modal */}
                    <PriorityMatrixModal
                        isOpen={isPriorityMatrixModalOpen}
                        onClose={() => setIsPriorityMatrixModalOpen(false)}
                        clients={clients}
                        onClientUpdate={(id, updates) => {
                            const updated = Database.update(id, updates);
                            if (updated) {
                                loadClients();
                                showToast('Client priority updated', 'success');
                            }
                        }}
                    />
                    
                    {/* Financial Forecaster Modal */}
                    <FinancialForecasterModal
                        isOpen={isFinancialForecasterModalOpen}
                        onClose={() => setIsFinancialForecasterModalOpen(false)}
                        clients={clients}
                    />
                    
                    {/* Toast Container */}
                    <ToastContainer toasts={toasts} onClose={closeToast} />
                </>
            );
        };

        /**
         * Clients Modal Component
         * Displays a card view of clients with filtering options
         */
        const ClientsModal = ({ clients, onClose }) => {
            const [viewFilter, setViewFilter] = useState('all');
            const [clientView, setClientView] = useState('cards');
            const [searchQuery, setSearchQuery] = useState('');
            
            const filteredModalClients = useMemo(() => {
                // First filter by view filter
                let filtered = [...clients];
                
                if (viewFilter === 'active') {
                    filtered = filtered.filter(client => client.status === 'Active');
                } else if (viewFilter === 'new') {
                    filtered = filtered.filter(client => client.status === 'New');
                } else if (viewFilter === 'quote') {
                    filtered = filtered.filter(client => client.status === 'Quote');
                } else if (viewFilter === 'high-priority') {
                    filtered = filtered.filter(client => client.priority === 'High');
                }
                
                // Then filter by search query if it exists
                if (searchQuery.trim() !== '') {
                    const query = searchQuery.toLowerCase().trim();
                    filtered = filtered.filter(client => 
                        client.name.toLowerCase().includes(query) || 
                        client.phone.toLowerCase().includes(query) || 
                        (client.email && client.email.toLowerCase().includes(query)) ||
                        (client.address && client.address.toLowerCase().includes(query))
                    );
                }
                
                return filtered;
            }, [clients, viewFilter, searchQuery]);
            
            const handleViewClient = (client) => {
                // Close the clients modal
                onClose();
                
                // Set the current client and open the client modal
                // These functions are available in the parent scope
                window.setCurrentClient(client);
                window.setIsClientModalOpen(true);
            };
            
            return (
                <div className="clients-modal-content">
                    <div className="filter-controls">
                        <div className="search-box">
                            <input
                                type="text"
                                placeholder="Search clients..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="search-input"
                            />
                            {searchQuery && (
                                <button 
                                    className="clear-search" 
                                    onClick={() => setSearchQuery('')}
                                    aria-label="Clear search"
                                >
                                    ×
                                </button>
                            )}
                        </div>
                        
                        <div className="view-filters">
                            <h3 style={{ marginRight: '0.5rem', marginBottom: '0.5rem' }}>Filter by:</h3>
                            <button 
                                className={viewFilter === 'all' ? 'active' : ''} 
                                onClick={() => setViewFilter('all')}
                            >
                                All Clients
                            </button>
                            <button 
                                className={viewFilter === 'active' ? 'active' : ''} 
                                onClick={() => setViewFilter('active')}
                            >
                                Active
                            </button>
                            <button 
                                className={viewFilter === 'new' ? 'active' : ''} 
                                onClick={() => setViewFilter('new')}
                            >
                                New
                            </button>
                            <button 
                                className={viewFilter === 'quote' ? 'active' : ''} 
                                onClick={() => setViewFilter('quote')}
                            >
                                Quote
                            </button>
                            <button 
                                className={viewFilter === 'high-priority' ? 'active' : ''} 
                                onClick={() => setViewFilter('high-priority')}
                            >
                                High Priority
                            </button>
                        </div>
                        
                        <div className="view-toggle">
                            <h3 style={{ marginRight: '0.5rem', marginBottom: '0.5rem' }}>View:</h3>
                            <button 
                                className={clientView === 'cards' ? 'active' : ''} 
                                onClick={() => setClientView('cards')}
                                aria-label="Card view"
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" strokeWidth="2"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" strokeWidth="2"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" strokeWidth="2"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" strokeWidth="2"/>
                                </svg>
                            </button>
                            <button 
                                className={clientView === 'list' ? 'active' : ''} 
                                onClick={() => setClientView('list')}
                                aria-label="List view"
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 6H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M8 12H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M8 18H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M3 6H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M3 12H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                    <path d="M3 18H3.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    {clientView === 'cards' ? (
                        <>
                            <div className="results-counter">
                                Showing {filteredModalClients.length} {filteredModalClients.length === 1 ? 'client' : 'clients'}
                                {searchQuery && <span> matching "{searchQuery}"</span>}
                                {viewFilter !== 'all' && <span> filtered by {viewFilter}</span>}
                            </div>
                            <div className="client-cards">
                            {filteredModalClients.length > 0 ? (
                                filteredModalClients.map(client => (
                                    <div key={client.id} className={`client-card priority-${client.priority.toLowerCase()}`}>
                                        <div className="client-card-header">
                                            <h3>{client.name}</h3>
                                            <span className={`status-badge status-${client.status.toLowerCase()}`}>
                                                {client.status}
                                            </span>
                                        </div>
                                        <div className="client-card-body">
                                            <p><strong>Phone:</strong> {client.phone}</p>
                                            {client.email && <p><strong>Email:</strong> {client.email}</p>}
                                            {client.address && <p><strong>Address:</strong> {client.address}</p>}
                                            {client.serviceNeeds && <p><strong>Service:</strong> {client.serviceNeeds}</p>}
                                            <p>
                                                <strong>Priority:</strong> 
                                                <span className={`priority-indicator priority-${client.priority.toLowerCase()}`}>
                                                    {client.priority}
                                                </span>
                                            </p>
                                            {client.quoteAmount && <p><strong>Quote Amount:</strong> ${parseFloat(client.quoteAmount).toFixed(2)}</p>}
                                            
                                            <div className="client-dates">
                                                {client.scheduledDate && <p><strong>Scheduled:</strong> {Utils.formatDate(client.scheduledDate)}</p>}
                                                <p><strong>Inquiry:</strong> {Utils.formatDate(client.inquiryDate)}</p>
                                            </div>
                                        </div>
                                        <div className="client-card-footer">
                                            <button 
                                                onClick={() => handleViewClient(client)}
                                                className="sm primary"
                                            >
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="no-results">No clients match the selected filter.</div>
                            )}
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="results-counter">
                                Showing {filteredModalClients.length} {filteredModalClients.length === 1 ? 'client' : 'clients'}
                                {searchQuery && <span> matching "{searchQuery}"</span>}
                                {viewFilter !== 'all' && <span> filtered by {viewFilter}</span>}
                            </div>
                            <div className="client-list">
                            {filteredModalClients.length > 0 ? (
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                            <th>Priority</th>
                                            <th>Quote Amount</th>
                                            <th>Scheduled Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredModalClients.map(client => (
                                            <tr key={client.id} className={`priority-${client.priority.toLowerCase()}`}>
                                                <td><strong>{client.name}</strong></td>
                                                <td>{client.phone}</td>
                                                <td>
                                                    <span className={`status-badge status-${client.status.toLowerCase()}`}>
                                                        {client.status}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span className={`priority-indicator priority-${client.priority.toLowerCase()}`}>
                                                        {client.priority}
                                                    </span>
                                                </td>
                                                <td>{client.quoteAmount ? `$${parseFloat(client.quoteAmount).toFixed(2)}` : '-'}</td>
                                                <td>{client.scheduledDate ? Utils.formatDate(client.scheduledDate) : '-'}</td>
                                                <td>
                                                    <button 
                                                        onClick={() => handleViewClient(client)}
                                                        className="sm primary"
                                                    >
                                                        View
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div className="no-results">No clients match the selected filter.</div>
                            )}
                            </div>
                        </>
                    )}
                    
                    <div className="modal-footer">
                        <button onClick={onClose} className="secondary">Close</button>
                    </div>
                </div>
            );
        };

        /**
         * Priority Matrix Component
         * Displays clients in a 2x2 matrix based on value and urgency
         */
        const PriorityMatrix = ({ clients, onClientUpdate }) => {
            // Group clients by their quadrant
            const [matrixClients, setMatrixClients] = useState({
                q1: [], // High Value, High Urgency
                q2: [], // High Value, Low Urgency
                q3: [], // Low Value, High Urgency
                q4: []  // Low Value, Low Urgency
            });
            
            // Determine client value score (1-10) based on quote amount and status
            const calculateValueScore = (client) => {
                // If client has a manually set value, use that
                if (client.clientValue) {
                    return parseInt(client.clientValue);
                }
                
                let score = 5; // Default middle score
                
                // Adjust based on quote amount if available
                if (client.quoteAmount) {
                    const amount = parseFloat(client.quoteAmount.replace(/[^0-9.-]+/g, ""));
                    if (amount > 5000) score += 3;
                    else if (amount > 2000) score += 2;
                    else if (amount > 1000) score += 1;
                }
                
                // Adjust based on status
                if (client.status === 'Active') score += 1;
                else if (client.status === 'Quote') score += 0.5;
                
                return Math.min(Math.max(score, 1), 10); // Ensure score is between 1-10
            };
            
            // Determine client urgency score (1-10) based on priority and dates
            const calculateUrgencyScore = (client) => {
                let score = 5; // Default middle score
                
                // Adjust based on priority
                if (client.priority === 'Urgent') score += 4;
                else if (client.priority === 'High') score += 2;
                else if (client.priority === 'Medium') score += 0;
                else if (client.priority === 'Low') score -= 2;
                
                // Adjust based on scheduled date if available
                if (client.scheduledDate) {
                    const scheduledDate = new Date(client.scheduledDate);
                    // Create adjusted date at noon to avoid timezone issues
                    const adjustedScheduledDate = new Date(scheduledDate.getFullYear(), scheduledDate.getMonth(), scheduledDate.getDate(), 12, 0, 0);
                    const today = new Date();
                    const adjustedToday = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 12, 0, 0);
                    
                    const daysUntilScheduled = Math.ceil(
                        (adjustedScheduledDate - adjustedToday) / (1000 * 60 * 60 * 24)
                    );
                    
                    if (daysUntilScheduled <= 3) score += 2;
                    else if (daysUntilScheduled <= 7) score += 1;
                    else if (daysUntilScheduled <= 14) score += 0;
                    else score -= 1;
                }
                
                return Math.min(Math.max(score, 1), 10); // Ensure score is between 1-10
            };
            
            // Determine which quadrant a client belongs to
            const getClientQuadrant = (client) => {
                const valueScore = calculateValueScore(client);
                const urgencyScore = calculateUrgencyScore(client);
                
                if (valueScore >= 6 && urgencyScore >= 6) return 'q1'; // High Value, High Urgency
                if (valueScore >= 6 && urgencyScore < 6) return 'q2';  // High Value, Low Urgency
                if (valueScore < 6 && urgencyScore >= 6) return 'q3';  // Low Value, High Urgency
                return 'q4'; // Low Value, Low Urgency
            };
            
            // Initialize matrix with clients
            useEffect(() => {
                const matrix = {
                    q1: [],
                    q2: [],
                    q3: [],
                    q4: []
                };
                
                clients.forEach(client => {
                    const quadrant = getClientQuadrant(client);
                    matrix[quadrant].push({
                        ...client,
                        valueScore: calculateValueScore(client),
                        urgencyScore: calculateUrgencyScore(client)
                    });
                });
                
                // Sort clients within each quadrant by combined score
                Object.keys(matrix).forEach(quadrant => {
                    matrix[quadrant].sort((a, b) => 
                        (b.valueScore + b.urgencyScore) - (a.valueScore + a.urgencyScore)
                    );
                });
                
                setMatrixClients(matrix);
            }, [clients]);
            
            // Handle dragging a client to a new quadrant
            const handleDragEnd = (result) => {
                if (!result.destination) return;
                
                const sourceQuadrant = result.source.droppableId;
                const destQuadrant = result.destination.droppableId;
                
                if (sourceQuadrant === destQuadrant) return;
                
                // Get the client that was moved
                const clientIndex = result.source.index;
                const client = matrixClients[sourceQuadrant][clientIndex];
                
                // Update client priority based on new quadrant
                let newPriority = client.priority;
                let newStatus = client.status;
                
                if (destQuadrant === 'q1') { // High Value, High Urgency
                    newPriority = 'Urgent';
                    if (newStatus === 'New') newStatus = 'Active';
                } else if (destQuadrant === 'q2') { // High Value, Low Urgency
                    newPriority = 'Medium';
                } else if (destQuadrant === 'q3') { // Low Value, High Urgency
                    newPriority = 'High';
                } else if (destQuadrant === 'q4') { // Low Value, Low Urgency
                    newPriority = 'Low';
                }
                
                // Call the update function to persist changes
                if (newPriority !== client.priority || newStatus !== client.status) {
                    onClientUpdate(client.id, { 
                        priority: newPriority,
                        status: newStatus
                    });
                }
            };
            
            // Render a client card in the matrix
            const renderClientCard = (client, index) => (
                <div 
                    key={client.id}
                    className="matrix-client-card"
                    draggable
                    onClick={() => onClientUpdate(client.id, {})} // Just to view the client details
                >
                    <div className="matrix-client-name">{client.name}</div>
                    <div className="matrix-client-details">
                        <span className={`status-badge status-${client.status.toLowerCase()}`}>
                            {client.status}
                        </span>
                        <span className={`priority-${client.priority.toLowerCase()}`}>
                            {client.priority}
                        </span>
                    </div>
                    <div className="matrix-client-scores">
                        <small>Value: {client.valueScore}/10</small>
                        <small>Urgency: {client.urgencyScore}/10</small>
                    </div>
                    {client.quoteAmount && (
                        <div className="matrix-client-quote">${client.quoteAmount}</div>
                    )}
                </div>
            );
            
            return (
                <div className="priority-matrix-container">
                    <div className="matrix-header">
                        <h3>Client Priority Matrix</h3>
                        <p>Drag clients between quadrants to reprioritize them</p>
                    </div>
                    
                    <div className="matrix-grid">
                        <div className="matrix-axis-labels">
                            <div className="y-axis-label">Value</div>
                            <div className="x-axis-label">Urgency</div>
                        </div>
                        
                        <div className="matrix-quadrants">
                            <div className="matrix-row">
                                <div className="matrix-quadrant q2">
                                    <div className="quadrant-header">
                                        <h4>High Value, Low Urgency</h4>
                                        <p>Plan for these clients</p>
                                    </div>
                                    <div className="quadrant-clients">
                                        {matrixClients.q2.map(renderClientCard)}
                                    </div>
                                </div>
                                <div className="matrix-quadrant q1">
                                    <div className="quadrant-header">
                                        <h4>High Value, High Urgency</h4>
                                        <p>Focus on these clients first</p>
                                    </div>
                                    <div className="quadrant-clients">
                                        {matrixClients.q1.map(renderClientCard)}
                                    </div>
                                </div>
                            </div>
                            <div className="matrix-row">
                                <div className="matrix-quadrant q4">
                                    <div className="quadrant-header">
                                        <h4>Low Value, Low Urgency</h4>
                                        <p>Handle when time permits</p>
                                    </div>
                                    <div className="quadrant-clients">
                                        {matrixClients.q4.map(renderClientCard)}
                                    </div>
                                </div>
                                <div className="matrix-quadrant q3">
                                    <div className="quadrant-header">
                                        <h4>Low Value, High Urgency</h4>
                                        <p>Delegate or handle quickly</p>
                                    </div>
                                    <div className="quadrant-clients">
                                        {matrixClients.q3.map(renderClientCard)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Priority Matrix Modal
         */
        const PriorityMatrixModal = ({ isOpen, onClose, clients, onClientUpdate }) => {
            return (
                <Modal
                    title="Client Priority Matrix"
                    isOpen={isOpen}
                    onClose={onClose}
                    children={
                        <PriorityMatrix 
                            clients={clients} 
                            onClientUpdate={onClientUpdate}
                        />
                    }
                    footer={
                        <div className="modal-footer">
                            <button onClick={onClose}>Close</button>
                        </div>
                    }
                />
            );
        };

        /**
         * Client Priority Dashboard component
         * Displays a visual representation of client priorities
         */
        const ClientPriorityDashboard = ({ clients }) => {
            // Group clients by priority
            const priorityGroups = useMemo(() => {
                const groups = {
                    Urgent: [],
                    High: [],
                    Medium: [],
                    Low: []
                };
                
                clients.forEach(client => {
                    if (groups[client.priority]) {
                        groups[client.priority].push(client);
                    }
                });
                
                // Sort each group by client value if available, otherwise by name
                Object.keys(groups).forEach(priority => {
                    groups[priority].sort((a, b) => {
                        if (a.clientValue && b.clientValue) {
                            return parseInt(b.clientValue) - parseInt(a.clientValue);
                        }
                        return a.name.localeCompare(b.name);
                    });
                });
                
                return groups;
            }, [clients]);
            
            return (
                <div className="priority-dashboard">
                    <h2>Client Priority Dashboard</h2>
                    <div className="priority-columns">
                        {Object.keys(priorityGroups).map(priority => (
                            <div key={priority} className={`priority-column priority-${priority.toLowerCase()}-column`}>
                                <div className="priority-column-header">
                                    <h3>{priority}</h3>
                                    <span className="client-count">{priorityGroups[priority].length}</span>
                                </div>
                                <div className="priority-client-list">
                                    {priorityGroups[priority].map(client => (
                                        <div 
                                            key={client.id} 
                                            className="priority-client-card"
                                            onClick={() => {
                                                window.setCurrentClient(client);
                                                window.setIsClientModalOpen(true);
                                            }}
                                        >
                                            <div className="priority-client-name">{client.name}</div>
                                            <div className="priority-client-details">
                                                <span className={`status-badge status-${client.status.toLowerCase()}`}>
                                                    {client.status}
                                                </span>
                                                {client.clientValue && (
                                                    <span className="client-value-badge">
                                                        Value: {client.clientValue}/10
                                                    </span>
                                                )}
                                            </div>
                                            {client.scheduledDate && (
                                                <div className="priority-client-date">
                                                    <small>Scheduled: {(() => {
                                                        const date = new Date(client.scheduledDate);
                                                        // Adjust for timezone by setting to noon
                                                        const adjusted = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                                                        return adjusted.toLocaleDateString();
                                                    })()}</small>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    {priorityGroups[priority].length === 0 && (
                                        <div className="empty-priority-message">
                                            No {priority.toLowerCase()} priority clients
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        /**
         * Financial Forecaster Component
         * Provides earnings projections and financial analytics
         */
        const FinancialForecaster = ({ clients }) => {
            const [forecastPeriod, setForecastPeriod] = useState('month');
            const [forecastMonths, setForecastMonths] = useState(6);
            const [completionRate, setCompletionRate] = useState(85);
            
            // Calculate financial data based on clients
            const financialData = useMemo(() => {
                // Get current date for calculations
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                // Initialize data structure for forecast
                const months = [];
                const projectedEarnings = [];
                const confirmedEarnings = [];
                const potentialEarnings = [];
                
                // Create month labels for the chart
                for (let i = 0; i < forecastMonths; i++) {
                    const forecastDate = new Date(currentYear, currentMonth + i, 1);
                    months.push(forecastDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                    projectedEarnings.push(0);
                    confirmedEarnings.push(0);
                    potentialEarnings.push(0);
                }
                
                // Process each client to calculate earnings
                clients.forEach(client => {
                    // Skip clients without quote amounts
                    if (!client.quoteAmount) return;
                    
                    const quoteAmount = parseFloat(client.quoteAmount) || 0;
                    
                    // Handle scheduled clients (confirmed earnings)
                    if (client.scheduledDate) {
                        const scheduledDate = new Date(client.scheduledDate);
                        // Fix timezone issues by working with local date components
                        const adjustedScheduledDate = new Date(scheduledDate.getFullYear(), scheduledDate.getMonth(), scheduledDate.getDate(), 12, 0, 0);
                        const monthDiff = (adjustedScheduledDate.getFullYear() - currentYear) * 12 + 
                                          adjustedScheduledDate.getMonth() - currentMonth;
                        
                        // If the scheduled date is within our forecast period
                        if (monthDiff >= 0 && monthDiff < forecastMonths) {
                            confirmedEarnings[monthDiff] += quoteAmount;
                            projectedEarnings[monthDiff] += quoteAmount;
                        }
                    } 
                    // Handle quote status clients (potential earnings)
                    else if (client.status === 'Quote') {
                        // Distribute potential earnings based on typical conversion timeline
                        // Assume quotes convert within 1-3 months with diminishing probability
                        const conversionRate = completionRate / 100;
                        
                        // Simple distribution model: 50% in month 1, 30% in month 2, 20% in month 3
                        potentialEarnings[0] += quoteAmount * 0.5 * conversionRate;
                        if (forecastMonths > 1) potentialEarnings[1] += quoteAmount * 0.3 * conversionRate;
                        if (forecastMonths > 2) potentialEarnings[2] += quoteAmount * 0.2 * conversionRate;
                        
                        // Add to projected earnings
                        projectedEarnings[0] += quoteAmount * 0.5 * conversionRate;
                        if (forecastMonths > 1) projectedEarnings[1] += quoteAmount * 0.3 * conversionRate;
                        if (forecastMonths > 2) projectedEarnings[2] += quoteAmount * 0.2 * conversionRate;
                    }
                    // Handle active clients without scheduled dates
                    else if (client.status === 'Active' && !client.scheduledDate) {
                        // Assume active clients will be serviced in the next month
                        confirmedEarnings[0] += quoteAmount;
                        projectedEarnings[0] += quoteAmount;
                    }
                });
                
                // Calculate summary statistics
                const totalProjected = projectedEarnings.reduce((sum, val) => sum + val, 0);
                const totalConfirmed = confirmedEarnings.reduce((sum, val) => sum + val, 0);
                const totalPotential = potentialEarnings.reduce((sum, val) => sum + val, 0);
                
                // Calculate monthly averages
                const monthlyAverage = totalProjected / forecastMonths;
                
                // Calculate growth rate (simple month-over-month)
                let growthRate = 0;
                if (projectedEarnings[0] > 0 && forecastMonths > 1) {
                    const firstMonth = projectedEarnings[0];
                    const lastMonth = projectedEarnings[forecastMonths - 1];
                    growthRate = ((lastMonth / firstMonth) ** (1 / (forecastMonths - 1)) - 1) * 100;
                }
                
                return {
                    months,
                    projectedEarnings,
                    confirmedEarnings,
                    potentialEarnings,
                    totalProjected,
                    totalConfirmed,
                    totalPotential,
                    monthlyAverage,
                    growthRate
                };
            }, [clients, forecastMonths, completionRate]);
            
            // Render the earnings chart using HTML/CSS (in a real app, you'd use a charting library)
            const renderChart = () => {
                const maxValue = Math.max(...financialData.projectedEarnings) * 1.1; // Add 10% padding
                
                return (
                    <div className="earnings-chart">
                        <div className="chart-container">
                            <div className="y-axis">
                                {[0, 1, 2, 3, 4].map(i => (
                                    <div key={i} className="y-label">
                                        ${Math.round(maxValue * (4 - i) / 4).toLocaleString()}
                                    </div>
                                ))}
                            </div>
                            <div className="chart-content">
                                <div className="chart-grid">
                                    {[0, 1, 2, 3, 4].map(i => (
                                        <div key={i} className="grid-line" style={{ bottom: `${i * 25}%` }}></div>
                                    ))}
                                </div>
                                <div className="chart-bars">
                                    {financialData.months.map((month, index) => (
                                        <div key={month} className="chart-column">
                                            <div className="bar-container">
                                                <div 
                                                    className="bar confirmed-bar" 
                                                    style={{ 
                                                        height: `${(financialData.confirmedEarnings[index] / maxValue) * 100}%` 
                                                    }}
                                                    title={`Confirmed: $${financialData.confirmedEarnings[index].toLocaleString()}`}
                                                ></div>
                                                <div 
                                                    className="bar potential-bar" 
                                                    style={{ 
                                                        height: `${(financialData.potentialEarnings[index] / maxValue) * 100}%` 
                                                    }}
                                                    title={`Potential: $${financialData.potentialEarnings[index].toLocaleString()}`}
                                                ></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="x-axis">
                            {financialData.months.map((month) => (
                                <div key={month} className="x-label">{month}</div>
                            ))}
                        </div>
                        
                        <div className="chart-legend">
                            <div className="legend-item">
                                <div className="legend-color confirmed-color"></div>
                                <div>Confirmed Earnings</div>
                            </div>
                            <div className="legend-item">
                                <div className="legend-color potential-color"></div>
                                <div>Potential Earnings</div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="financial-forecaster">
                    <div className="forecaster-controls">
                        <div className="form-row">
                            <div className="form-group">
                                <label htmlFor="forecastPeriod">Forecast Period</label>
                                <select 
                                    id="forecastPeriod" 
                                    value={forecastPeriod}
                                    onChange={(e) => setForecastPeriod(e.target.value)}
                                >
                                    <option value="month">Monthly</option>
                                    <option value="quarter">Quarterly</option>
                                    <option value="year">Yearly</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label htmlFor="forecastMonths">Number of Months</label>
                                <select 
                                    id="forecastMonths" 
                                    value={forecastMonths}
                                    onChange={(e) => setForecastMonths(parseInt(e.target.value))}
                                >
                                    <option value="3">3 Months</option>
                                    <option value="6">6 Months</option>
                                    <option value="12">12 Months</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label htmlFor="completionRate">Quote Completion Rate (%)</label>
                                <input 
                                    type="range" 
                                    id="completionRate" 
                                    min="0" 
                                    max="100" 
                                    value={completionRate}
                                    onChange={(e) => setCompletionRate(parseInt(e.target.value))}
                                />
                                <div className="range-value">{completionRate}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="financial-summary">
                        <div className="summary-card">
                            <h3>Total Projected Earnings</h3>
                            <div className="summary-value">${financialData.totalProjected.toLocaleString()}</div>
                        </div>
                        <div className="summary-card">
                            <h3>Confirmed Earnings</h3>
                            <div className="summary-value">${financialData.totalConfirmed.toLocaleString()}</div>
                        </div>
                        <div className="summary-card">
                            <h3>Potential Earnings</h3>
                            <div className="summary-value">${financialData.totalPotential.toLocaleString()}</div>
                        </div>
                        <div className="summary-card">
                            <h3>Monthly Average</h3>
                            <div className="summary-value">${financialData.monthlyAverage.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div className="chart-section">
                        <h3>Earnings Projection</h3>
                        {renderChart()}
                    </div>
                    
                    <div className="forecast-insights">
                        <h3>Financial Insights</h3>
                        <ul>
                            <li>
                                <strong>Projected Growth Rate:</strong> {financialData.growthRate.toFixed(2)}% month-over-month
                            </li>
                            <li>
                                <strong>Confirmed vs. Projected Ratio:</strong> {financialData.totalConfirmed > 0 
                                    ? ((financialData.totalConfirmed / financialData.totalProjected) * 100).toFixed(2) 
                                    : 0}%
                            </li>
                            <li>
                                <strong>Highest Earning Month:</strong> {financialData.months[
                                    financialData.projectedEarnings.indexOf(Math.max(...financialData.projectedEarnings))
                                ]} (${Math.max(...financialData.projectedEarnings).toLocaleString()})
                            </li>
                        </ul>
                    </div>
                </div>
            );
        };

        /**
         * Financial Forecaster Modal
         */
        const FinancialForecasterModal = ({ isOpen, onClose, clients }) => {
            return (
                <Modal
                    title="Financial Forecaster"
                    isOpen={isOpen}
                    onClose={onClose}
                    children={
                        <FinancialForecaster clients={clients} />
                    }
                    footer={
                        <div className="modal-footer">
                            <button onClick={onClose}>Close</button>
                        </div>
                    }
                />
            );
        };

        /**
         * Work Calendar component for visualizing scheduled work
         */
        const WorkCalendar = ({ clients }) => {
            // State for calendar
            const [currentDate, setCurrentDate] = useState(new Date());
            const [viewMode, setViewMode] = useState('month'); // 'month', 'week', 'day'
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [isEventModalOpen, setIsEventModalOpen] = useState(false);
            const [googleCalendarEvents, setGoogleCalendarEvents] = useState([]);
            const [isCalendarAuthorized, setIsCalendarAuthorized] = useState(false);
            const [isAddingGoogleEvent, setIsAddingGoogleEvent] = useState(false);
            
            // Google Calendar API integration
            useEffect(() => {
                // Check if the Google Calendar API is initialized
                const checkCalendarAuth = () => {
                    if (window.gapi && gapi.client && gapi.client.getToken()) {
                        setIsCalendarAuthorized(true);
                        fetchGoogleCalendarEvents();
                    } else {
                        setIsCalendarAuthorized(false);
                    }
                };
                
                // Set up polling to check auth status
                const interval = setInterval(checkCalendarAuth, 2000);
                
                // Clean up on unmount
                return () => clearInterval(interval);
            }, []);
            
            // Fetch events from Google Calendar
            const fetchGoogleCalendarEvents = async () => {
                if (!isCalendarAuthorized || !window.gapi || !gapi.client) return;
                
                try {
                    const response = await gapi.client.calendar.events.list({
                        'calendarId': 'primary',
                        'timeMin': new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString(),
                        'timeMax': new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString(),
                        'showDeleted': false,
                        'singleEvents': true,
                        'maxResults': 100,
                        'orderBy': 'startTime'
                    });
                    
                    const events = response.result.items || [];
                    
                    // Transform to our event format
                    const googleEvents = events.map(event => {
                        const start = event.start.dateTime ? new Date(event.start.dateTime) : new Date(event.start.date);
                        const end = event.end.dateTime ? new Date(event.end.dateTime) : new Date(event.end.date);
                        
                        return {
                            id: `google-${event.id}`,
                            title: event.summary,
                            start,
                            end,
                            googleEvent: event,
                            type: 'google',
                            priority: 'Medium' // Default priority for Google events
                        };
                    });
                    
                    setGoogleCalendarEvents(googleEvents);
                } catch (error) {
                    console.error('Error fetching Google Calendar events:', error);
                }
            };
            
            // Refresh Google Calendar events when current date changes
            useEffect(() => {
                if (isCalendarAuthorized) {
                    fetchGoogleCalendarEvents();
                }
            }, [currentDate, isCalendarAuthorized]);
            
            // Generate events from clients
            const events = useMemo(() => {
                return clients
                    .filter(client => client.scheduledDate) // Only include clients with scheduled dates
                    .map(client => {
                        // Fix timezone issue by parsing the date correctly
                        const dateObj = new Date(client.scheduledDate);
                        // Create date at noon to avoid timezone issues
                        const adjustedDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12, 0, 0);
                        
                        return {
                            id: `scheduled-${client.id}`,
                            title: `${client.name} - ${client.serviceNeeds || 'Scheduled Work'}`,
                            start: adjustedDate,
                            end: adjustedDate,
                            client: client,
                            type: 'scheduled',
                            priority: client.priority
                        };
                    });
            }, [clients]);
            
            // Handle navigation
            const handlePrevious = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') {
                    newDate.setMonth(newDate.getMonth() - 1);
                } else if (viewMode === 'week') {
                    newDate.setDate(newDate.getDate() - 7);
                } else if (viewMode === 'day') {
                    newDate.setDate(newDate.getDate() - 1);
                }
                setCurrentDate(newDate);
            };
            
            const handleNext = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') {
                    newDate.setMonth(newDate.getMonth() + 1);
                } else if (viewMode === 'week') {
                    newDate.setDate(newDate.getDate() + 7);
                } else if (viewMode === 'day') {
                    newDate.setDate(newDate.getDate() + 1);
                }
                setCurrentDate(newDate);
            };
            
            const handleToday = () => {
                setCurrentDate(new Date());
            };
            
            // Format date display
            const formatDateDisplay = () => {
                if (viewMode === 'month') {
                    return new Intl.DateTimeFormat('en-US', { 
                        year: 'numeric', 
                        month: 'long' 
                    }).format(currentDate);
                } else if (viewMode === 'week') {
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    
                    return `${new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' }).format(startOfWeek)} - ${new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(endOfWeek)}`;
                } else if (viewMode === 'day') {
                    return new Intl.DateTimeFormat('en-US', { 
                        weekday: 'long',
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }).format(currentDate);
                }
            };
            
            // Handle event click
            const handleEventClick = (event) => {
                setSelectedEvent(event);
                setIsEventModalOpen(true);
            };
            
            // Generate days for month view
            const generateMonthDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                // First day of the month
                const firstDay = new Date(year, month, 1);
                // Last day of the month
                const lastDay = new Date(year, month + 1, 0);
                
                // Start from the previous month's days that appear in the first week
                const startDay = new Date(firstDay);
                startDay.setDate(startDay.getDate() - startDay.getDay());
                
                // End with the next month's days that appear in the last week
                const endDay = new Date(lastDay);
                endDay.setDate(endDay.getDate() + (6 - endDay.getDay()));
                
                const days = [];
                let currentDay = new Date(startDay);
                
                while (currentDay <= endDay) {
                    days.push(new Date(currentDay));
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                
                return days;
            };
            
            // Filter events for a specific day
            const getEventsForDay = (day) => {
                return events.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate.getDate() === day.getDate() && 
                           eventDate.getMonth() === day.getMonth() && 
                           eventDate.getFullYear() === day.getFullYear();
                });
            };
            
            // Render month view
            const renderMonthView = () => {
                const days = generateMonthDays();
                
                return (
                    <div className="calendar-month-view">
                        <div className="calendar-weekdays">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                <div key={day} className="calendar-weekday">{day}</div>
                            ))}
                        </div>
                        <div className="calendar-days">
                            {days.map((day, index) => {
                                const isToday = day.toDateString() === new Date().toDateString();
                                const isDifferentMonth = day.getMonth() !== currentDate.getMonth();
                                const dayEvents = getEventsForDay(day);
                                
                                return (
                                    <div 
                                        key={index} 
                                        className={`calendar-day ${isToday ? 'today' : ''} ${isDifferentMonth ? 'different-month' : ''}`}
                                    >
                                        <div className="calendar-day-header">{day.getDate()}</div>
                                        <div className="calendar-day-events">
                                            {dayEvents.map(event => (
                                                <div 
                                                    key={event.id} 
                                                    className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                                    onClick={() => handleEventClick(event)}
                                                >
                                                    {event.title}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            // Render week view
            const renderWeekView = () => {
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                
                const days = Array.from({ length: 7 }, (_, i) => {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    return day;
                });
                
                return (
                    <div className="calendar-week-view">
                        <div className="calendar-weekdays">
                            {days.map((day, index) => {
                                const isToday = day.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div key={index} className={`calendar-weekday ${isToday ? 'today' : ''}`}>
                                        <div>{new Intl.DateTimeFormat('en-US', { weekday: 'short' }).format(day)}</div>
                                        <div>{day.getDate()}</div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="calendar-week-body">
                            {days.map((day, dayIndex) => {
                                const dayEvents = getEventsForDay(day);
                                const isToday = day.toDateString() === new Date().toDateString();
                                
                                return (
                                    <div key={dayIndex} className={`calendar-week-column ${isToday ? 'today' : ''}`}>
                                        {dayEvents.map(event => (
                                            <div 
                                                key={event.id} 
                                                className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                                onClick={() => handleEventClick(event)}
                                            >
                                                {event.title}
                                            </div>
                                        ))}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            // Render day view
            const renderDayView = () => {
                const dayEvents = getEventsForDay(currentDate);
                
                return (
                    <div className="calendar-day-view">
                        <div className="calendar-day-header">
                            <h3>{new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(currentDate)}</h3>
                        </div>
                        <div className="calendar-day-body">
                            {dayEvents.length > 0 ? (
                                dayEvents.map(event => (
                                    <div 
                                        key={event.id} 
                                        className={`calendar-event ${event.type === 'google' ? 'type-google' : `priority-${event.priority.toLowerCase()} status-${event.client?.status?.toLowerCase() || 'default'}`}`}
                                        onClick={() => handleEventClick(event)}
                                    >
                                        <div className="event-title">{event.title}</div>
                                    </div>
                                ))
                            ) : (
                                <div className="no-events">No events scheduled for this day</div>
                            )}
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="work-calendar">
                    <div className="calendar-header">
                        <h2>Work Calendar</h2>
                        
                        <div className="calendar-controls">
                            <div className="calendar-navigation">
                                <button onClick={handlePrevious} className="calendar-nav-button" aria-label="Previous">
                                    <span aria-hidden="true">◀</span>
                                </button>
                        <div className="calendar-navigation">
                            <button onClick={handlePrevious}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 18L9 12L15 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                            <button onClick={handleToday}>Today</button>
                            <button onClick={handleNext}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 18L15 12L9 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                            <div className="calendar-date-display">{formatDateDisplay()}</div>
                        </div>
                        <div className="calendar-view-options">
                            <button 
                                onClick={() => setViewMode('month')} 
                                className={viewMode === 'month' ? 'active' : ''}
                            >
                                Month
                            </button>
                            <button 
                                onClick={() => setViewMode('week')} 
                                className={viewMode === 'week' ? 'active' : ''}
                            >
                                Week
                            </button>
                            <button 
                                onClick={() => setViewMode('day')} 
                                className={viewMode === 'day' ? 'active' : ''}
                            >
                                Day
                            </button>
                        </div>
                    </div>
                    
                    {/* Google Calendar Integration UI */}
                    <div className="google-calendar-integration">
                        <div className="calendar-auth-section">
                            <h3>Google Calendar Integration</h3>
                            
                            {!isCalendarAuthorized ? (
                                <button 
                                    id="calendar-authorize" 
                                    onClick={handleAuthClick} 
                                    className="calendar-button btn secondary"
                                    disabled={!window.gapi}
                                >
                                    Connect Google Calendar
                                </button>
                            ) : (
                                <>
                                    <div className="calendar-status connected">
                                        <span className="status-icon">✓</span>
                                        Connected to Google Calendar
                                    </div>
                                    <div className="calendar-actions">
                                        <button 
                                            id="calendar-signout" 
                                            onClick={handleSignoutClick} 
                                            className="calendar-button btn-sm secondary"
                                        >
                                            Disconnect
                                        </button>
                                        <button 
                                            onClick={fetchGoogleCalendarEvents} 
                                            className="calendar-button btn-sm"
                                            disabled={isAddingGoogleEvent}
                                        >
                                            Refresh Calendar
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {viewMode === 'month' && renderMonthView()}
                    {viewMode === 'week' && renderWeekView()}
                    {viewMode === 'day' && renderDayView()}
                    
                    {selectedEvent && (
                        <Modal
                            isOpen={isEventModalOpen}
                            onClose={() => setIsEventModalOpen(false)}
                            title="Event Details"
                        >
                            <div className="event-details">
                                <h3>{selectedEvent.title}</h3>
                                <p><strong>Date:</strong> {(() => {
                                    const date = new Date(selectedEvent.start);
                                    // Make sure we have a consistent display by using a specific time to avoid timezone issues
                                    return date.toLocaleDateString();
                                })()}</p>
                                
                                {selectedEvent.type === 'scheduled' && (
                                    <>
                                        <p><strong>Client:</strong> {selectedEvent.client.name}</p>
                                        <p><strong>Phone:</strong> {selectedEvent.client.phone}</p>
                                        <p><strong>Status:</strong> {selectedEvent.client.status}</p>
                                        <p><strong>Priority:</strong> {selectedEvent.client.priority}</p>
                                        {selectedEvent.client.serviceNeeds && (
                                            <p><strong>Service Needs:</strong> {selectedEvent.client.serviceNeeds}</p>
                                        )}
                                        {selectedEvent.client.locationDetails && (
                                            <p><strong>Location Details:</strong> {selectedEvent.client.locationDetails}</p>
                                        )}
                                        {selectedEvent.client.notes && (
                                            <div>
                                                <strong>Notes:</strong>
                                                <p className="client-notes">{selectedEvent.client.notes}</p>
                                            </div>
                                        )}
                                        
                                        {/* Google Calendar Integration */}
                                        {isCalendarAuthorized && !selectedEvent.client.calendarEventId && (
                                            <div className="calendar-integration-actions">
                                                <button 
                                                    onClick={() => handleCreateGoogleEvent(selectedEvent.client)}
                                                    className="btn"
                                                    disabled={isAddingGoogleEvent}
                                                >
                                                    {isAddingGoogleEvent ? 'Creating...' : 'Add to Google Calendar'}
                                                </button>
                                            </div>
                                        )}
                                        
                                        {selectedEvent.client.calendarEventId && (
                                            <div className="calendar-integration-info">
                                                <p>
                                                    <strong>Google Calendar:</strong> 
                                                    <span className="calendar-status">✓ Synced</span>
                                                </p>
                                                {selectedEvent.client.calendarEventLink && (
                                                    <a 
                                                        href={selectedEvent.client.calendarEventLink} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="btn-sm secondary"
                                                    >
                                                        Open in Google Calendar
                                                    </a>
                                                )}
                                            </div>
                                        )}
                                    </>
                                )}
                                
                                {selectedEvent.type === 'google' && (
                                    <>
                                        <p><strong>Google Calendar Event</strong></p>
                                        <p>
                                            <strong>Time:</strong> {new Date(selectedEvent.start).toLocaleTimeString()} - {new Date(selectedEvent.end).toLocaleTimeString()}
                                        </p>
                                        {selectedEvent.googleEvent.location && (
                                            <p><strong>Location:</strong> {selectedEvent.googleEvent.location}</p>
                                        )}
                                        {selectedEvent.googleEvent.description && (
                                            <div>
                                                <strong>Description:</strong>
                                                <p className="event-description">{selectedEvent.googleEvent.description}</p>
                                            </div>
                                        )}
                                        <a 
                                            href={selectedEvent.googleEvent.htmlLink} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="btn secondary"
                                        >
                                            Open in Google Calendar
                                        </a>
                                    </>
                                )}
                            </div>
                            <div className="modal-footer">
                                {selectedEvent.type === 'scheduled' && (
                                    <button onClick={() => {
                                        window.setCurrentClient(selectedEvent.client);
                                        window.setIsClientModalOpen(true);
                                        setIsEventModalOpen(false);
                                    }}>View Client</button>
                                )}
                                <button className="secondary" onClick={() => setIsEventModalOpen(false)}>Close</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        /**
         * Client Map Component
         * Displays client locations on a Google Map
         */
        const ClientMap = ({ clients }) => {
            const [isLoaded, setIsLoaded] = useState(false);
            const [mapInstance, setMapInstance] = useState(null);
            const [markers, setMarkers] = useState([]);
            const [filteredPriority, setFilteredPriority] = useState('all');
            const [filteredStatus, setFilteredStatus] = useState('all');
            const mapRef = useRef(null);
            
            // Function to geocode addresses
            const geocodeAddress = async (address) => {
                return new Promise((resolve, reject) => {
                    if (!address) {
                        console.error('Empty address provided to geocoder');
                        resolve(null);
                        return;
                    }

                    try {
                        if (!google || !google.maps || !google.maps.Geocoder) {
                            console.error('Google Maps Geocoder not available');
                            resolve(null);
                            return;
                        }
                        
                        const geocoder = new google.maps.Geocoder();
                        
                        console.log(`Sending to geocoder: "${address}"`);
                        
                        geocoder.geocode({ address }, (results, status) => {
                            if (status === 'OK' && results && results.length > 0) {
                                resolve(results[0].geometry.location);
                            } else {
                                console.warn(`Geocoding failed for address: "${address}". Status: ${status}`);
                                
                                // If the address came from our new structured format, it might have commas 
                                // that confuse the geocoder. Try without commas.
                                if (address.includes(',')) {
                                    console.log('Attempting alternative address format...');
                                    const simplifiedAddress = address.split(',').join(' ');
                                    
                                    geocoder.geocode({ address: simplifiedAddress }, (altResults, altStatus) => {
                                        if (altStatus === 'OK' && altResults && altResults.length > 0) {
                                            console.log('Alternative geocoding successful');
                                            resolve(altResults[0].geometry.location);
                                        } else {
                                            console.warn(`Alternative geocoding also failed. Status: ${altStatus}`);
                                            resolve(null);
                                        }
                                    });
                                } else {
                                    resolve(null);
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error in geocodeAddress:', error);
                        resolve(null);
                    }
                });
            };
            
            // Initialize the map once the component mounts
            useEffect(() => {
                try {
                    if (typeof google !== 'undefined' && google && google.maps && mapRef.current && !mapInstance) {
                        console.log('Initializing Google Map...');
                        
                        const mapOptions = {
                            center: { lat: 39.8283, lng: -98.5795 }, // Center of the US as default
                            zoom: 4,
                            mapTypeId: google.maps.MapTypeId.ROADMAP,
                            mapTypeControl: true,
                            streetViewControl: false,
                            styles: [
                                {
                                    featureType: "poi",
                                    elementType: "labels",
                                    stylers: [{ visibility: "off" }]
                                }
                            ]
                        };
                        
                        const newMap = new google.maps.Map(mapRef.current, mapOptions);
                        setMapInstance(newMap);
                        setIsLoaded(true);
                        console.log('Google Map initialized successfully');
                    }
                } catch (error) {
                    console.error('Error initializing Google Map:', error);
                }
            }, [mapRef.current, google]);
            
            // Add markers when clients change or map is loaded
            useEffect(() => {
                const plotMarkers = async () => {
                    if (isLoaded && mapInstance && clients.length > 0) {
                        console.log(`Attempting to plot ${clients.length} clients on map`);
                        
                        // Remove existing markers
                        markers.forEach(marker => marker.setMap(null));
                        setMarkers([]);
                        
                        const newMarkers = [];
                        const bounds = new google.maps.LatLngBounds();
                        let hasValidMarkers = false;
                        
                        // Create info window for marker click
                        const infoWindow = new google.maps.InfoWindow();
                        
                        // Filter clients based on current filters
                        const filteredClients = clients.filter(client => {
                            const hasAddress = client.address && client.address.trim() !== '';
                            const hasCoordinates = typeof client.latitude === 'number' && 
                                                  typeof client.longitude === 'number' && 
                                                  !isNaN(client.latitude) && 
                                                  !isNaN(client.longitude);
                            
                            if (!hasAddress && !hasCoordinates) {
                                console.log(`Client ${client.name} has no address or coordinates`);
                            }
                            
                            return (filteredPriority === 'all' || client.priority === filteredPriority) && 
                                   (filteredStatus === 'all' || client.status === filteredStatus) &&
                                   (hasAddress || hasCoordinates);
                        });
                        
                        console.log(`After filtering, ${filteredClients.length} clients to display on map`);
                        
                        // Plot each client's address as a marker
                        for (const client of filteredClients) {
                            console.log(`Processing client for map: ${client.name}`);
                            
                            try {
                                let location = null;
                                
                                // First check if we have latitude/longitude coordinates
                                if (typeof client.latitude === 'number' && typeof client.longitude === 'number' && 
                                    !isNaN(client.latitude) && !isNaN(client.longitude)) {
                                    console.log(`Using stored coordinates for ${client.name}: [${client.latitude}, ${client.longitude}]`);
                                    location = new google.maps.LatLng(client.latitude, client.longitude);
                                }
                                // Otherwise try geocoding the address
                                else if (client.address) {
                                    console.log(`No coordinates for ${client.name}, attempting to geocode address: ${client.address}`);
                                    location = await geocodeAddress(client.address);
                                }
                                else {
                                    console.log(`Client ${client.name} has neither coordinates nor address`);
                                    continue;
                                }
                                
                                if (location) {
                                    console.log(`Successfully located ${client.name} on the map`);
                                    
                                    // Determine marker color based on priority
                                    const priorityColor = {
                                        'Urgent': '#e53935', // danger-color
                                        'High': '#ff9800',   // warning-color
                                        'Medium': '#4caf50', // primary-color-light
                                        'Low': '#1976d2'     // info-color
                                    }[client.priority] || '#4caf50';
                                    
                                    // Create marker
                                    const marker = new google.maps.Marker({
                                        position: location,
                                        map: mapInstance,
                                        title: client.name,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            fillColor: priorityColor,
                                            fillOpacity: 0.9,
                                            strokeWeight: 1,
                                            strokeColor: '#ffffff',
                                            scale: 10
                                        },
                                        animation: google.maps.Animation.DROP
                                    });
                                    
                                    // Format the address parts for display
                                    const formatAddressParts = (address) => {
                                        if (!address) return '';
                                        const parts = address.split(',').map(part => part.trim());
                                        return parts.join('<br>');
                                    };
                                    
                                    // Add client info to marker for info window
                                    const contentString = `
                                        <div class="info-window">
                                            <h3>${client.name}</h3>
                                            <p><strong>Address:</strong><br> ${formatAddressParts(client.address)}</p>
                                            ${client.latitude && client.longitude ? 
                                              `<p><strong>Coordinates:</strong> [${client.latitude.toFixed(6)}, ${client.longitude.toFixed(6)}]</p>` : ''}
                                            <p><strong>Phone:</strong> ${client.phone}</p>
                                            <p><strong>Status:</strong> ${client.status}</p>
                                            <p><strong>Priority:</strong> ${client.priority}</p>
                                            ${client.scheduledDate ? `<p><strong>Scheduled:</strong> ${new Date(client.scheduledDate).toLocaleDateString()}</p>` : ''}
                                            <p><button onclick="editClientFromMap('${client.id}')">Edit Client</button></p>
                                        </div>
                                    `;
                                    
                                    // Add click listener to show info window
                                    marker.addListener('click', () => {
                                        infoWindow.setContent(contentString);
                                        infoWindow.open(mapInstance, marker);
                                        
                                        // Set the current client to the clicked marker
                                        window.setCurrentClient(client);
                                    });
                                    
                                    // Double click to open client modal
                                    marker.addListener('dblclick', () => {
                                        window.setCurrentClient(client);
                                        window.setIsClientModalOpen(true);
                                    });
                                    
                                    // Extend bounds to include this marker
                                    bounds.extend(location);
                                    hasValidMarkers = true;
                                    newMarkers.push(marker);
                                } else {
                                    console.warn(`Could not geocode address for ${client.name}: ${client.address}`);
                                }
                            } catch (error) {
                                console.error(`Error plotting marker for ${client.name}:`, error);
                            }
                        }
                        
                        setMarkers(newMarkers);
                        console.log(`Added ${newMarkers.length} markers to the map`);
                        
                        // Fit map to bounds if we have valid markers
                        if (hasValidMarkers && newMarkers.length > 0) {
                            mapInstance.fitBounds(bounds);
                            
                            // Don't zoom in too far for single markers
                            const listener = google.maps.event.addListener(mapInstance, 'idle', () => {
                                if (mapInstance.getZoom() > 16) {
                                    mapInstance.setZoom(16);
                                }
                                google.maps.event.removeListener(listener);
                            });
                        } else {
                            console.warn('No valid markers to display on map');
                            // Reset to default view if no markers
                            mapInstance.setCenter({ lat: 39.8283, lng: -98.5795 });
                            mapInstance.setZoom(4);
                        }
                    }
                };
                
                plotMarkers();
            }, [isLoaded, mapInstance, clients, filteredPriority, filteredStatus]);
            
            // Handle filter changes
            const handlePriorityFilter = (e) => {
                setFilteredPriority(e.target.value);
            };
            
            const handleStatusFilter = (e) => {
                setFilteredStatus(e.target.value);
            };
            
            // Add this check before using Google APIs
            useEffect(() => {
                console.log('Setting up Google Maps event listener');
                
                const handleMapsLoaded = () => {
                    console.log("Maps loaded event received");
                    setIsLoaded(true);
                };
                
                // Check if already loaded
                if (window.google && window.google.maps) {
                    console.log('Google Maps already available');
                    setIsLoaded(true);
                } else {
                    console.log('Waiting for Google Maps to load...');
                    window.addEventListener('google-maps-loaded', handleMapsLoaded);
                    
                    // As a backup, check for Google Maps availability every second
                    const checkInterval = setInterval(() => {
                        if (window.google && window.google.maps) {
                            console.log('Google Maps detected through interval check');
                            clearInterval(checkInterval);
                            setIsLoaded(true);
                            window.removeEventListener('google-maps-loaded', handleMapsLoaded);
                        }
                    }, 1000);
                    
                    // Clear interval after 10 seconds to prevent memory leaks
                    setTimeout(() => {
                        clearInterval(checkInterval);
                    }, 10000);
                }
                
                return () => {
                    window.removeEventListener('google-maps-loaded', handleMapsLoaded);
                };
            }, []);
            
            return (
                <div className="client-map-container">
                    <h2>
                        Client Location Map
                        <div className="map-controls">
                            <select 
                                value={filteredPriority} 
                                onChange={handlePriorityFilter}
                                className="filter-control"
                            >
                                <option value="all">All Priorities</option>
                                <option value="Urgent">Urgent</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                            
                            <select 
                                value={filteredStatus} 
                                onChange={handleStatusFilter}
                                className="filter-control"
                            >
                                <option value="all">All Statuses</option>
                                <option value="New">New</option>
                                <option value="Quote">Quote</option>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </h2>
                    
                    {!isLoaded ? (
                        <div className="loading-map">Loading map...</div>
                    ) : (
                        <>
                            <div ref={mapRef} className="client-map"></div>
                            
                            {markers.length === 0 && clients.length > 0 && (
                                <div className="map-error-message">
                                    No clients found with valid location information. Please ensure clients have either complete address information or latitude/longitude coordinates.
                                </div>
                            )}
                            
                            <div className="map-legend">
                                <div className="map-legend-item">
                                    <div className="map-legend-color" style={{backgroundColor: '#e53935'}}></div>
                                    <span>Urgent</span>
                                </div>
                                <div className="map-legend-item">
                                    <div className="map-legend-color" style={{backgroundColor: '#ff9800'}}></div>
                                    <span>High</span>
                                </div>
                                <div className="map-legend-item">
                                    <div className="map-legend-color" style={{backgroundColor: '#4caf50'}}></div>
                                    <span>Medium</span>
                                </div>
                                <div className="map-legend-item">
                                    <div className="map-legend-color" style={{backgroundColor: '#1976d2'}}></div>
                                    <span>Low</span>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>